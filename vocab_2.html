<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vocabulary MCQ Exam</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{
      --bg:#0f172a;
      --card:#111827;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --accent:#22c55e;
      --accent-weak:#16a34a;
      --danger:#ef4444;
      --warning:#f59e0b;
      --info:#60a5fa;
      --ring: rgba(34,197,94,0.4);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: linear-gradient(180deg, #0b1220, var(--bg));
      color: var(--text);
    }
    .container {
        max-width: 950px;
        width: 100%;
        margin: 0 auto;
        padding: 0 20px;
        flex: 1;
    }
    header{
      width: 100%; position: sticky; top: 0; z-index: 10; backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(2,6,23,0.92), rgba(2,6,23,0.6));
      border-bottom: 1px solid rgba(148,163,184,0.15);
    }
    .header-inner{ display:flex; align-items:center; gap:16px; padding:14px 24px; }
    .brand{ font-weight:700; letter-spacing:0.3px; }
    .pill{ padding: 6px 10px; background: #0b1324; border:1px solid rgba(148,163,184,0.15); border-radius: 9999px; color: var(--muted); font-size:12px; }
    .timer{ margin-left:auto; font-variant-numeric: tabular-nums; font-weight:700; padding:6px 12px; border-radius:10px; background:#0b1a2f; border:1px solid rgba(96,165,250,0.3); color:#bfdbfe; }
    .controls{ display:flex; gap:8px; }
    button{
      background: #0b1220; color: var(--text); border:1px solid rgba(148,163,184,0.2); border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:600;
    }
    button:hover{ border-color: rgba(148,163,184,0.35); }
    button.primary{ background: linear-gradient(180deg, var(--accent), var(--accent-weak)); border-color: transparent; color:#052e16; }
    button.primary:hover{ filter: brightness(0.98); }

    .card{ background: #0b1220; border:1px solid rgba(148,163,184,0.15); border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.35); }
    .intro{ padding: 20px; margin-top: 16px; }
    .intro p{ color: var(--muted); margin:8px 0 0; }

    .meta{ display:flex; flex-wrap:wrap; gap:12px; margin-top:10px; }
    .meta .chip{ font-size: 13px; padding:6px 10px; border-radius:8px; background:#091225; border:1px solid rgba(148,163,184,0.2); color:#cbd5e1 }

    .question{ padding: 20px; border-top: 1px solid rgba(148,163,184,0.12); }
    .q-head{ display:flex; gap:10px; align-items:flex-start; }
    .q-num{ width:34px; height:34px; border-radius:50%; display:grid; place-content:center; background:#0b1a2f; color:#bfdbfe; font-weight:700; border:1px solid rgba(96,165,250,0.35) }
    .q-text{ font-weight:600; line-height:1.4 }

    .options{ margin-top:12px; display:grid; gap:10px; }

    /* Custom radio style */
    .option{
      display:flex; align-items:flex-start; gap:12px; padding:12px; border:1px solid rgba(148,163,184,0.18); border-radius:12px; cursor:pointer; background:#0a1020;
    }
    .option:hover{ border-color: rgba(148,163,184,0.32) }
    .option input{ appearance:none; -webkit-appearance:none; width:18px; height:18px; border-radius: 50%; border:2px solid #93c5fd; margin-top:3px; display:inline-grid; place-content:center; outline:none; }
    .option input::before{ content:""; width:10px; height:10px; border-radius:50%; transform: scale(0); transition:120ms transform ease-in-out; background: #60a5fa; }
    .option input:checked::before{ transform: scale(1); }
    .option .opt-text{ flex:1; }

    .actions{ position:sticky; bottom:0; background:linear-gradient(180deg, rgba(2,6,23,0), rgba(2,6,23,0.9) 25%, rgba(2,6,23,1)); padding:16px 24px; display:flex; gap:10px; justify-content:space-between; align-items:center; border-top:1px solid rgba(148,163,184,0.15);}

    .result{ padding: 18px 20px; border-top: 1px solid rgba(148,163,184,0.12); background:#081427; }
    .result strong{ color:#bbf7d0 }
    .legend{ display:flex; gap:10px; flex-wrap:wrap; color:var(--muted); font-size:14px }
    .legend span{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; background:#0b1324; border:1px solid rgba(148,163,184,0.2); border-radius:9999px }
    .dot{ width:10px; height:10px; border-radius:50% }
    .dot.correct{ background: var(--accent) }
    .dot.wrong{ background: var(--danger) }
    .dot.unanswered{ background: #facc15; }

    .unanswered-chip {
        color: #facc15;
        border-color: rgba(250, 204, 21, 0.4); 
     }
     
     .correct-chip {
        color: #22c55e;
        border-color: rgba(250, 204, 21, 0.4); 
     }

     .wrong-chip {
        color: #ef4444;
        border-color: rgba(250, 204, 21, 0.4); 
     }


    .correct{ border-color: rgba(34,197,94,0.6) !important; background: rgba(34,197,94,0.06) }
    .wrong{ border-color: rgba(239,68,68,0.6) !important; background: rgba(239,68,68,0.06) }
    
    /* Enhanced explanation styling */
    .explanation-container { margin-top: 12px; padding: 12px; border-radius: 8px; background: rgba(30, 41, 59, 0.4); }
    .result-status { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600;}
    .correct-status { color: var(--accent); }
    .wrong-status { color: var(--danger); }
    .unanswered-status { color: #facc15; } 
    .explain{ color:#cbd5e1; font-size:14px; opacity:0.95; margin: 0; }

    .hidden{ display:none !important }
    .mute{ color: var(--muted) }
    .footer-note{ text-align:center; color:var(--muted); margin: 16px 0 40px; font-size:13px }
    .score-badge{ font-weight:800; color:#052e16; background:linear-gradient(180deg, #86efac, #22c55e); border-radius:9999px; padding:6px 12px; border:1px solid var(--accent-weak) }
    
    /* User setup modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      backdrop-filter: blur(5px);
    }
    
    .modal {
      background: var(--card);
      border-radius: 16px;
      padding: 24px;
      width: 90%;
      max-width: 450px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      border: 1px solid rgba(148,163,184,0.2);
    }
    
    .modal h2 {
      margin-top: 0;
      margin-bottom: 16px;
    }
    
    .modal input {
      width: 100%;
      padding: 12px;
      background: #0b1324;
      border: 1px solid rgba(148,163,184,0.2);
      border-radius: 8px;
      color: var(--text);
      margin-bottom: 16px;
    }
    
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    /* Ranking table */
    .ranking-table-container {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--card);
      border-radius: 16px;
      padding: 24px;
      width: 90%;
      max-width: 700px;
      max-height: 80vh;
      overflow-y: auto;
      z-index: 100;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      border: 1px solid rgba(148,163,184,0.2);
    }
    
    .ranking-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .ranking-search {
      padding: 8px 12px;
      background: #0b1324;
      border: 1px solid rgba(148,163,184,0.2);
      border-radius: 8px;
      color: var(--text);
      width: 200px;
    }
    
    .ranking-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .ranking-table th, .ranking-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(148,163,184,0.1);
    }
    
    .ranking-table th {
      color: var(--muted);
      font-weight: 600;
    }
    
    .ranking-table tr:hover {
      background: rgba(148,163,184,0.05);
    }
    
    .current-user-row {
      background: rgba(34,197,94,0.1) !important;
      font-weight: 600;
    }
    
    .user-rank {
      font-weight: 700;
      color: var(--accent);
    }
    
    .user-points {
      font-weight: 600;
    }
    
    .close-ranking {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 18px;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-right: auto;
    }
    
    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }
    
    @media (max-width:640px){ 
        .q-head{ flex-direction:column; }
        .header-inner { flex-wrap: wrap; }
        .controls { order: 3; width: 100%; justify-content: center; margin-top: 10px; }
        .timer { margin-left: 0; }
        .ranking-table-container { padding: 16px; }
        .ranking-table th, .ranking-table td { padding: 8px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner container">
      <div class="user-info">
        <div class="user-avatar" id="userAvatar">U</div>
        <span id="usernameDisplay">Guest</span>
      </div>
      <div class="brand">📚 Vocabulary MCQ Exam</div>
      <span class="pill">10 Questions • 10 Minutes • +1 / −0.25 / 0</span>
      <div id="timer" class="timer" aria-live="polite">10:00</div>
      <div class="controls">
        <button id="rankingBtn">Ranking</button>
        <button id="startBtn" class="primary">Start Exam</button>
        <button id="resetBtn" title="Start a new exam">New Exam</button>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="card intro" id="intro">
      <h2 style="margin:0 0 6px">Instructions</h2>
      <ul>
        <li>10 questions will be drawn randomly from the full pool of 15.</li>
        <li>All questions are on <strong>Vocabulary (English-Bengali, Bengali-English, Synonyms, Antonyms)</strong>.</li>
        <li>Scoring: Correct +1, Wrong −0.25, Unanswered 0.</li>
        <li>Time limit: 10 minutes. Auto-submit when time ends.</li>
        <li>All questions appear on one page — scroll to navigate.</li>
        <li>Your score will be added to your ranking points.</li>
      </ul>
      
      <div class="meta">
        <div class="chip">Current Points: <span id="userPoints">0</span></div>
        <div class="chip">Exams Taken: <span id="examsTaken">0</span></div>
      </div>
    </section>

    <div id="summary" class="card result hidden" role="status" aria-live="polite"></div>

    <form id="exam" class="card" autocomplete="off"></form>

    <div class="actions">
      <div class="legend">
        <span><span class="dot correct"></span> Correct</span>
        <span><span class="dot wrong"></span> Wrong</span>
        <span><span class="dot unanswered"></span> Unanswered</span>
      </div>
      <button id="submitBtn" class="primary" disabled>Submit Exam</button>
    </div>
  </main>

  <!-- User Setup Modal -->
  <div id="userSetupModal" class="modal-overlay">
    <div class="modal">
      <h2>Enter Your Username</h2>
      <p style="color: var(--muted); margin-top: -8px; margin-bottom: 16px;">This will be used for the ranking system.</p>
      <input type="text" id="usernameInput" placeholder="Choose a username" maxlength="20" />
      <div class="modal-buttons">
        <button id="saveUsernameBtn" class="primary">Save & Continue</button>
      </div>
    </div>
  </div>

  <!-- Ranking Table -->
  <div id="rankingTable" class="ranking-table-container hidden">
    <div class="ranking-header">
      <h2 style="margin: 0;">Global Ranking</h2>
      <input type="text" class="ranking-search" id="rankingSearch" placeholder="Search users..." />
      <button class="close-ranking" id="closeRankingBtn"><i class="fas fa-times"></i></button>
    </div>
    <div id="userRankInfo" style="margin-bottom: 16px; padding: 8px; background: rgba(34,197,94,0.1); border-radius: 8px;">
      Your rank: <span id="currentUserRank">-</span>
    </div>
    <table class="ranking-table">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Username</th>
          <th>Points</th>
          <th>Exams</th>
          <th>Last Activity</th>
        </tr>
      </thead>
      <tbody id="rankingTableBody">
        <!-- Will be populated by JavaScript -->
      </tbody>
    </table>
  </div>

  <script>
  // ----------------------------
  // Utilities
  // ----------------------------
  const EXAM_SIZE = 10;
  const EXAM_MINUTES = 10;
  const STORAGE_KEY = 'vocabulary_exam_state_v1';
  const USER_STORAGE_KEY = 'vocabulary_user_data';
  const RANKING_STORAGE_KEY = 'vocabulary_ranking_data';

  const qs = (sel, el=document) => el.querySelector(sel);
  const qsa = (sel, el=document) => [...el.querySelectorAll(sel)];
  const pick = (arr, n) => {
    const a = [...arr];
    for (let i=a.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
    return a.slice(0, n);
  };

  function formatTime(s){
    const m = Math.floor(s/60).toString().padStart(2,'0');
    const r = Math.floor(s%60).toString().padStart(2,'0');
    return `${m}:${r}`;
  }

  function saveState(state){ sessionStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function loadState(){ try{ return JSON.parse(sessionStorage.getItem(STORAGE_KEY)||'null'); }catch{return null} }
  function clearState(){ sessionStorage.removeItem(STORAGE_KEY); }

  // ----------------------------
  // User Management
  // ----------------------------
  function getUserData() {
    try {
      return JSON.parse(localStorage.getItem(USER_STORAGE_KEY)) || null;
    } catch {
      return null;
    }
  }
  
  function saveUserData(userData) {
    try {
      localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(userData));
      return true;
    } catch {
      return false;
    }
  }
  
  function getRankingData() {
    try {
      return JSON.parse(localStorage.getItem(RANKING_STORAGE_KEY)) || [];
    } catch {
      return [];
    }
  }
  
  function saveRankingData(rankingData) {
    try {
      localStorage.setItem(RANKING_STORAGE_KEY, JSON.stringify(rankingData));
      return true;
    } catch {
      return false;
    }
  }
  
  function updateUserRanking(username, score) {
    const rankingData = getRankingData();
    const now = new Date().toISOString();
    const userIndex = rankingData.findIndex(user => user.username === username);
    
    if (userIndex !== -1) {
      // Update existing user
      rankingData[userIndex].points += score;
      rankingData[userIndex].exams += 1;
      rankingData[userIndex].lastActivity = now;
    } else {
      // Add new user
      rankingData.push({
        username,
        points: score,
        exams: 1,
        lastActivity: now,
        joinDate: now
      });
    }
    
    // Sort by points descending
    rankingData.sort((a, b) => b.points - a.points);
    
    saveRankingData(rankingData);
    return rankingData;
  }
  
  function getCurrentUserRank(username, rankingData) {
    return rankingData.findIndex(user => user.username === username) + 1;
  }
  
  function displayRankingTable() {
    const rankingData = getRankingData();
    const userData = getUserData();
    const tableBody = qs('#rankingTableBody');
    const searchTerm = qs('#rankingSearch').value.toLowerCase();
    
    tableBody.innerHTML = '';
    
    let filteredData = rankingData;
    if (searchTerm) {
      filteredData = rankingData.filter(user => 
        user.username.toLowerCase().includes(searchTerm)
      );
    }
    
    filteredData.forEach((user, index) => {
      const row = document.createElement('tr');
      if (userData && user.username === userData.username) {
        row.classList.add('current-user-row');
        qs('#currentUserRank').textContent = `#${getCurrentUserRank(user.username, rankingData)}`;
      }
      
      row.innerHTML = `
        <td class="user-rank">#${getCurrentUserRank(user.username, rankingData)}</td>
        <td>${user.username}</td>
        <td class="user-points">${user.points.toFixed(2)}</td>
        <td>${user.exams}</td>
        <td>${new Date(user.lastActivity).toLocaleDateString()}</td>
      `;
      
      tableBody.appendChild(row);
    });
  }

  // ----------------------------
  // Question Pool (Vocabulary)
  // Each question: { id, q, options:[], answer: index, explain }
  // ----------------------------
  const QUESTIONS = [
    {
      id: 1,
      q: "Choose the Bengali meaning of: 'ubiquitous'",
      options: ["বিরল", "সর্বত্র বিদ্যমান", "গোপন", "অকার্যকর"],
      answer: 1,
      explain: "ব্যাখ্যা: 'Ubiquitous' শব্দের বাংলা অর্থ হলো 'সর্বত্র বিদ্যমান'। এটি এমন কিছু বোঝায় যা সব জায়গায় উপস্থিত বা পাওয়া যায়। যেমন: 'Mobile phones are ubiquitous in modern society.'"
    },
    {
      id: 2,
      q: "Choose the English meaning of: 'অবিশ্বাস্য'",
      options: ["Incredible", "Unbelievable", "Amazing", "All of the above"],
      answer: 3,
      explain: "ব্যাখ্যা: 'অবিশ্বাস্য' শব্দের ইংরেজি অর্থ Incredible, Unbelievable, Amazing - তিনটিই সঠিক। তাই 'All of the above' সঠিক উত্তর।"
    },
    {
      id: 3,
      q: "Select the synonym of: 'Benevolent'",
      options: ["Cruel", "Kind", "Stingy", "Indifferent"],
      answer: 1,
      explain: "ব্যাখ্যা: 'Benevolent' শব্দের অর্থ দয়ালু, পরোপকারী। এর synonym বা প্রতিশব্দ হলো 'Kind'।"
    },
    {
      id: 4,
      q: "Select the antonym of: 'Transparent'",
      options: ["Clear", "Opaque", "Visible", "Lucrative"],
      answer: 1,
      explain: "ব্যাখ্যা: 'Transparent' শব্দের অর্থ স্বচ্ছ। এর antonym বা বিপরীত শব্দ হলো 'Opaque' যার অর্থ অস্বচ্ছ।"
    },
    {
      id: 5,
      q: "Choose the Bengali meaning of: 'Perseverance'",
      options: ["হতাশা", "অধ্যবসায়", "সমর্পণ", "বিরতি"],
      answer: 1,
      explain: "ব্যাখ্যা: 'Perseverance' শব্দের বাংলা অর্থ হলো 'অধ্যবসায়'। এটি কোনো কাজে লেগে থাকার মানসিকতা বা দৃঢ়তা বোঝায়।"
    },
    {
      id: 6,
      q: "Choose the English meaning of: 'সমৃদ্ধ'",
      options: ["Poor", "Wealthy", "Destitute", "Scarce"],
      answer: 1,
      explain: "ব্যাখ্যা: 'সমৃদ্ধ' শব্দের ইংরেজি অর্থ হলো 'Wealthy' বা 'Prosperous'। এটি ধন-সম্পদে পূর্ণ বা উন্নত অবস্থাকে বোঝায়।"
    },
    {
      id: 7,
      q: "Select the synonym of: 'Diligent'",
      options: ["Lazy", "Hardworking", "Careless", "Forgetful"],
      answer: 1,
      explain: "ব্যাখ্যা: 'Diligent' শব্দের অর্থ পরিশ্রমী, যত্নশীল। এর synonym বা প্রতিশব্দ হলো 'Hardworking'।"
    },
    {
      id: 8,
      q: "Select the antonym of: 'Expand'",
      options: ["Grow", "Contract", "Increase", "Extend"],
      answer: 1,
      explain: "ব্যাখ্যা: 'Expand' শব্দের অর্থ প্রসারিত করা বা বিস্তৃত করা। এর antonym বা বিপরীত শব্দ হলো 'Contract' যার অর্থ সংকুচিত করা।"
    },
    {
      id: 9,
      q: "Choose the Bengali meaning of: 'Eloquent'",
      options: ["মূক", "বাক্পটু", "অস্পষ্ট", "নীরব"],
      answer: 1,
      explain: "ব্যাখ্যা: 'Eloquent' শব্দের বাংলা অর্থ হলো 'বাক্পটু' বা 'বাক্চাতুর্য সম্পন্ন'। এটি এমন কাউকে বোঝায় who speaks fluently and persuasively."
    },
    {
      id: 10,
      q: "Choose the English meaning of: 'বিরক্ত'",
      options: ["Pleased", "Annoyed", "Delighted", "Content"],
      answer: 1,
      explain: "ব্যাখ্যা: 'বিরক্ত' শব্দের ইংরেজি অর্থ হলো 'Annoyed' বা 'Irritated'। এটি এমন feeling কে বোঝায় যখন someone is slightly angry or impatient."
    },
    {
      id: 11,
      q: "Select the synonym of: 'Meticulous'",
      options: ["Careless", "Thorough", "Sloppy", "Hasty"],
      answer: 1,
      explain: "ব্যাখ্যা: 'Meticulous' শব্দের অর্থ অত্যন্ত সতর্ক ও যত্নশীল,细节-oriented। এর synonym বা প্রতিশব্দ হলো 'Thorough'।"
    },
    {
      id: 12,
      q: "Select the antonym of: 'Generous'",
      options: ["Kind", "Stingy", "Charitable", "Benevolent"],
      answer: 1,
      explain: "ব্যাখ্যা: 'Generous' শব্দের অর্থ উদার, generous। এর antonym বা বিপরীত শব্দ হলো 'Stingy' যার meaning কৃপণ বা stingy।"
    },
    {
      id: 13,
      q: "Choose the Bengali meaning of: 'Resilient'",
      options: ["নমনীয়", "সহনশীল", "ভঙ্গুর", "দুর্বল"],
      answer: 1,
      explain: "ব্যাখ্যা: 'Resilient' শব্দের বাংলা অর্থ হলো 'সহনশীল' বা 'নমনীয়'। এটি এমন ability কে বোঝায় to recover quickly from difficulties."
    },
    {
      id: 14,
      q: "Choose the English meaning of: 'সৃজনশীল'",
      options: ["Destructive", "Creative", "Imitative", "Ordinary"],
      answer: 1,
      explain: "ব্যাখ্যা: 'সৃজনশীল' শব্দের ইংরেজি অর্থ হলো 'Creative'। এটি এমন ability কে বোঝায় to create or invent new things."
    },
    {
      id: 15,
      q: "Select the synonym of: ' prudent'",
      options: ["Reckless", "Wise", "Foolish", "Careless"],
      answer: 1,
      explain: "ব্যাখ্যা: 'Prudent' শব্দের অর্থ বিচক্ষণ, wise and careful। এর synonym বা প্রতিশব্দ হলো 'Wise'।"
    }
  ];

  // ----------------------------
  // State
  // ----------------------------
  let selectedIds = [];
  let selectedMap = {}; // { qid: optionIndex }
  let endTime = null; // epoch seconds
  let submitted = false;
  let timerHandle = null;
  let currentUser = null;

  // ----------------------------
  // DOM Elements
  // ----------------------------
  const examForm = qs('#exam');
  const startBtn = qs('#startBtn');
  const resetBtn = qs('#resetBtn');
  const submitBtn = qs('#submitBtn');
  const timerEl = qs('#timer');
  const summaryEl = qs('#summary');
  const introEl = qs('#intro');
  const rankingBtn = qs('#rankingBtn');
  const userSetupModal = qs('#userSetupModal');
  const usernameInput = qs('#usernameInput');
  const saveUsernameBtn = qs('#saveUsernameBtn');
  const rankingTable = qs('#rankingTable');
  const closeRankingBtn = qs('#closeRankingBtn');
  const rankingSearch = qs('#rankingSearch');
  const usernameDisplay = qs('#usernameDisplay');
  const userPoints = qs('#userPoints');
  const examsTaken = qs('#examsTaken');
  const userAvatar = qs('#userAvatar');

  // ----------------------------
  // Rendering
  // ----------------------------
  function renderQuestions(){
    examForm.innerHTML = '';
    const chosen = QUESTIONS.filter(q=>selectedIds.includes(q.id));
    chosen.forEach((q,idx)=>{
      const qWrap = document.createElement('section');
      qWrap.className = 'question';
      qWrap.setAttribute('data-qid', q.id);

      qWrap.innerHTML = `
        <div class="q-head">
          <div class="q-num">${idx+1}</div>
          <div class="q-text">${q.q}</div>
        </div>
        <div class="options" role="radiogroup" aria-label="Question ${idx+1}">
          ${q.options.map((opt,i)=>{
            const checked = selectedMap[q.id] === i ? 'checked' : '';
            return `
              <label class="option">
                <input type="radio" name="q_${q.id}" value="${i}" ${checked} aria-label="Option ${String.fromCharCode(65+i)}">
                <div class="opt-text"><strong>(${String.fromCharCode(65+i)})</strong> ${opt}</div>
              </label>
            `;}).join('')}
        </div>
      `;

      examForm.appendChild(qWrap);
    });

    // attach listeners
    qsa('input[type=radio]', examForm).forEach(inp=>{
      inp.addEventListener('change', e=>{
        const name = e.target.name; // q_<id>
        const qid = parseInt(name.split('_')[1],10);
        selectedMap[qid] = parseInt(e.target.value,10);
        persist();
      });
    })
  }

  function renderSummary(score, details){
    const total = EXAM_SIZE;
    const correct = details.filter(d=>d.correct).length;
    const wrong = details.filter(d=>d.user!==null && !d.correct).length;
    const unanswered = total - correct - wrong;

    summaryEl.classList.remove('hidden');
    summaryEl.innerHTML = `
      <div style="display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap">
        <div style="display:flex; gap:12px; align-items:center">
          <span class="score-badge" title="Final Score">Score: ${score.toFixed(2)} / ${total.toFixed(2)}</span>
          <span class="chip correct-chip">✅ ${correct} correct</span>
          <span class="chip wrong-chip">❌ ${wrong} wrong</span>
          <span class="chip unanswered-chip">⏳ ${unanswered} unanswered</span>
        </div>
        <button onclick="window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'})"> Go to Bottom</button>
      </div>
    `;
    
    // Update user points if logged in
    if (currentUser) {
      updateUserRanking(currentUser.username, score);
      updateUserDisplay();
    }
  }

  function markReview(details){
    // Color options + show explanations
    details.forEach((d,idx)=>{
      const sec = qs(`.question[data-qid="${d.id}"]`);
      if(!sec) return;
      const labels = qsa('.option', sec);
      labels.forEach((lab,i)=>{
        lab.classList.remove('correct','wrong');
        if(i===d.answer) lab.classList.add('correct');
        if(d.user!==null && i===d.user && !d.correct) lab.classList.add('wrong');
        lab.querySelector('input').disabled = true;
      });
      
      // Create explanation container with correct/wrong status
      const expContainer = document.createElement('div');
      expContainer.className = 'explanation-container';
      
      // Add correct/wrong status with icons
      const statusDiv = document.createElement('div');
      statusDiv.className = `result-status ${d.correct ? 'correct-status' : 'wrong-status'}`;
      
       if (d.correct) {
        statusDiv.className = 'result-status correct-status';
        statusDiv.innerHTML = `<i class="fas fa-check-circle"></i> Correct`;
      } else if (d.user !== null) {
        statusDiv.className = 'result-status wrong-status';
        statusDiv.innerHTML = `<i class="fas fa-times-circle"></i> Wrong`;
      } else {
        statusDiv.className = 'result-status unanswered-status';
        statusDiv.innerHTML = `<i class="fas fa-question-circle"></i> Unanswered`;
      }
      
      // Add explanation text
      const exp = document.createElement('p');
      exp.className = 'explain';
      exp.textContent = d.explain;
      
      // Append elements to container
      expContainer.appendChild(statusDiv);
      expContainer.appendChild(exp);
      
      // Append container to question section
      sec.appendChild(expContainer);
    });
  }

  // ----------------------------
  // User Management UI
  // ----------------------------
  function updateUserDisplay() {
    if (currentUser) {
      usernameDisplay.textContent = currentUser.username;
      userAvatar.textContent = currentUser.username.charAt(0).toUpperCase();
      
      const rankingData = getRankingData();
      const userInRanking = rankingData.find(user => user.username === currentUser.username);
      
      if (userInRanking) {
        userPoints.textContent = userInRanking.points.toFixed(2);
        examsTaken.textContent = userInRanking.exams;
      }
      
      userSetupModal.classList.add('hidden');
    } else {
      userSetupModal.classList.remove('hidden');
    }
  }

  // ----------------------------
  // Exam Flow
  // ----------------------------
  function startExam(){
    if (!currentUser) {
      alert("Please set a username first");
      userSetupModal.classList.remove('hidden');
      return;
    }
    
    if(selectedIds.length===0){
      selectedIds = pick(QUESTIONS, EXAM_SIZE).map(q=>q.id);
    }
    endTime = Math.floor(Date.now()/1000) + EXAM_MINUTES*60;
    submitted = false;
    submitBtn.disabled = false;
    introEl.classList.add('hidden');
    summaryEl.classList.add('hidden');
    renderQuestions();
    persist();
    startTimer();
  }

  function submitExam(reason='manual'){
    if(submitted) return;
    submitted = true;
    stopTimer();
    submitBtn.disabled = true;

    const chosen = QUESTIONS.filter(q=>selectedIds.includes(q.id));
    const details = chosen.map(q=>{
      const user = (q.id in selectedMap) ? selectedMap[q.id] : null;
      const correct = user===q.answer;
      return { id:q.id, user, answer:q.answer, correct, explain:q.explain };
    });

    const correctCount = details.filter(d=>d.correct).length;
    const wrongCount = details.filter(d=>d.user!==null && !d.correct).length;
    const score = correctCount*1 + wrongCount*(-0.25);

    renderSummary(score, details);
    markReview(details);

    // lock state
    persist();
  }

  function resetExam(){
    stopTimer();
    clearState();
    selectedIds = [];
    selectedMap = {};
    endTime = null;
    submitted = false;
    timerEl.textContent = formatTime(EXAM_MINUTES*60);
    submitBtn.disabled = true;
    summaryEl.classList.add('hidden');
    examForm.innerHTML = '';
    introEl.classList.remove('hidden');
    window.scrollTo({top:0,behavior:'smooth'});
  }

  // ----------------------------
  // Timer
  // ----------------------------
  function startTimer(){
    stopTimer();
    tick();
    timerHandle = setInterval(tick, 1000);
  }
  function stopTimer(){ if(timerHandle){ clearInterval(timerHandle); timerHandle=null; } }
  function tick(){
    const now = Math.floor(Date.now()/1000);
    const remain = Math.max(0, endTime - now);
    timerEl.textContent = formatTime(remain);

    // color hints
    if(remain <= 60){ timerEl.style.background = '#2b0b0b'; timerEl.style.color = '#fecaca'; timerEl.style.borderColor = 'rgba(248,113,113,0.4)'; }
    else if(remain <= 5*60){ timerEl.style.background = '#2b1a0b'; timerEl.style.color = '#fde68a'; timerEl.style.borderColor = 'rgba(245,158,11,0.4)'; }

    if(remain===0){ submitExam('timeout'); }
  }

  // ----------------------------
  // Persistence (sessionStorage)
  // ----------------------------
  function persist(){
    const state = { selectedIds, selectedMap, endTime, submitted };
    saveState(state);
  }
  function restore(){
    const state = loadState();
    if(!state) return;
    selectedIds = state.selectedIds||[];
    selectedMap = state.selectedMap||{}; 
    endTime = state.endTime||null;
    submitted = !!state.submitted;

    if(selectedIds.length){
      introEl.classList.add('hidden');
      renderQuestions();
      if(submitted){
        // rebuild review
        const chosen = QUESTIONS.filter(q=>selectedIds.includes(q.id));
        const details = chosen.map(q=>{
          const user = (q.id in selectedMap) ? selectedMap[q.id] : null;
          const correct = user===q.answer;
          return { id:q.id, user, answer:q.answer, correct, explain:q.explain };
        });
        const correctCount = details.filter(d=>d.correct).length;
        const wrongCount = details.filter(d=>d.user!==null && !d.correct).length;
        const score = correctCount*1 + wrongCount*(-0.25);
        submitBtn.disabled = true;
        renderSummary(score, details);
        markReview(details);
      } else if(endTime){
        submitBtn.disabled = false;
        startTimer();
      }
    }
  }

  // ----------------------------
  // Wiring
  // ----------------------------
  startBtn.addEventListener('click', () => {
    if(loadState() && !submitted){ if(!confirm('Start a new attempt? Your current attempt will be replaced.')) return; }
    resetExam();
    startExam();
  });
  resetBtn.addEventListener('click', resetExam);
  submitBtn.addEventListener('click', (e)=>{ e.preventDefault(); submitExam('manual'); window.scrollTo({top:0,behavior:'smooth'}); });
  
  rankingBtn.addEventListener('click', () => {
    rankingTable.classList.toggle('hidden');
    if (!rankingTable.classList.contains('hidden')) {
      displayRankingTable();
    }
  });
  
  closeRankingBtn.addEventListener('click', () => {
    rankingTable.classList.add('hidden');
  });
  
  rankingSearch.addEventListener('input', displayRankingTable);
  
  saveUsernameBtn.addEventListener('click', () => {
    const username = usernameInput.value.trim();
    if (username.length < 2) {
      alert("Username must be at least 2 characters long");
      return;
    }
    
    currentUser = { username };
    if (saveUserData(currentUser)) {
      updateUserDisplay();
    } else {
      alert("Failed to save user data. Please check if local storage is enabled.");
    }
  });

  window.addEventListener('beforeunload', (e)=>{
    // gentle reminder if exam running
    const state = loadState();
    if(state && state.selectedIds && state.selectedIds.length && !state.submitted){
      e.preventDefault(); e.returnValue = '';
    }
  });

  // Initialize
  (function init(){
    timerEl.textContent = formatTime(EXAM_MINUTES*60);
    
    // Load user data if exists
    const userData = getUserData();
    if (userData) {
      currentUser = userData;
    }
    
    updateUserDisplay();
    restore();
  })();
  </script>
</body>
</html>