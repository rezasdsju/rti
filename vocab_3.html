<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vocabulary MCQ Exam</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Sign-in -->
  <meta name="google-signin-client_id" content="YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com">
  <script src="https://apis.google.com/js/platform.js" async defer></script>
  <style>
    :root{
      --bg:#0f172a;
      --card:#111827;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --accent:#22c55e;
      --accent-weak:#16a34a;
      --danger:#ef4444;
      --warning:#f59e0b;
      --info:#60a5fa;
      --ring: rgba(34,197,94,0.4);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: linear-gradient(180deg, #0b1220, var(--bg));
      color: var(--text);
    }
    .container {
        max-width: 950px;
        width: 100%;
        margin: 0 auto;
        padding: 0 20px;
        flex: 1;
    }
    header{
      width: 100%; position: sticky; top: 0; z-index: 10; backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(2,6,23,0.92), rgba(2,6,23,0.6));
      border-bottom: 1px solid rgba(148,163,184,0.15);
    }
    .header-inner{ display:flex; align-items:center; gap:16px; padding:14px 24px; }
    .brand{ font-weight:700; letter-spacing:0.3px; }
    .pill{ padding: 6px 10px; background: #0b1324; border:1px solid rgba(148,163,184,0.15); border-radius: 9999px; color: var(--muted); font-size:12px; }
    .timer{ margin-left:auto; font-variant-numeric: tabular-nums; font-weight:700; padding:6px 12px; border-radius:10px; background:#0b1a2f; border:1px solid rgba(96,165,250,0.3); color:#bfdbfe; }
    .controls{ display:flex; gap:8px; }
    button{
      background: #0b1220; color: var(--text); border:1px solid rgba(148,163,184,0.2); border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:600;
    }
    button:hover{ border-color: rgba(148,163,184,0.35); }
    button.primary{ background: linear-gradient(180deg, var(--accent), var(--accent-weak)); border-color: transparent; color:#052e16; }
    button.primary:hover{ filter: brightness(0.98); }

    .card{ background: #0b1220; border:1px solid rgba(148,163,184,0.15); border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.35); }
    .intro{ padding: 20px; margin-top: 16px; }
    .intro p{ color: var(--muted); margin:8px 0 0; }

    .meta{ display:flex; flex-wrap:wrap; gap:12px; margin-top:10px; }
    .meta .chip{ font-size: 13px; padding:6px 10px; border-radius:8px; background:#091225; border:1px solid rgba(148,163,184,0.2); color:#cbd5e1 }

    .question{ padding: 20px; border-top: 1px solid rgba(148,163,184,0.12); }
    .q-head{ display:flex; gap:10px; align-items:flex-start; }
    .q-num{ width:34px; height:34px; border-radius:50%; display:grid; place-content:center; background:#0b1a2f; color:#bfdbfe; font-weight:700; border:1px solid rgba(96,165,250,0.35) }
    .q-text{ font-weight:600; line-height:1.4 }

    .options{ margin-top:12px; display:grid; gap:10px; }

    /* Custom radio style */
    .option{
      display:flex; align-items:flex-start; gap:12px; padding:12px; border:1px solid rgba(148,163,184,0.18); border-radius:12px; cursor:pointer; background:#0a1020;
    }
    .option:hover{ border-color: rgba(148,163,184,0.32) }
    .option input{ appearance:none; -webkit-appearance:none; width:18px; height:18px; border-radius: 50%; border:2px solid #93c5fd; margin-top:3px; display:inline-grid; place-content:center; outline:none; }
    .option input::before{ content:""; width:10px; height:10px; border-radius:50%; transform: scale(0); transition:120ms transform ease-in-out; background: #60a5fa; }
    .option input:checked::before{ transform: scale(1); }
    .option .opt-text{ flex:1; }

    .actions{ position:sticky; bottom:0; background:linear-gradient(180deg, rgba(2,6,23,0), rgba(2,6,23,0.9) 25%, rgba(2,6,23,1)); padding:16px 24px; display:flex; gap:10px; justify-content:space-between; align-items:center; border-top:1px solid rgba(148,163,184,0.15);}

    .result{ padding: 18px 20px; border-top: 1px solid rgba(148,163,184,0.12); background:#081427; }
    .result strong{ color:#bbf7d0 }
    .legend{ display:flex; gap:10px; flex-wrap:wrap; color:var(--muted); font-size:14px }
    .legend span{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; background:#0b1324; border:1px solid rgba(148,163,184,0.2); border-radius:9999px }
    .dot{ width:10px; height:10px; border-radius:50% }
    .dot.correct{ background: var(--accent) }
    .dot.wrong{ background: var(--danger) }
    .dot.unanswered{ background: #facc15; }

    .unanswered-chip {
        color: #facc15;
        border-color: rgba(250, 204, 21, 0.4); 
     }
     
     .correct-chip {
        color: #22c55e;
        border-color: rgba(250, 204, 21, 0.4); 
     }

     .wrong-chip {
        color: #ef4444;
        border-color: rgba(250, 204, 21, 0.4); 
     }

    .correct{ border-color: rgba(34,197,94,0.6) !important; background: rgba(34,197,94,0.06) }
    .wrong{ border-color: rgba(239,68,68,0.6) !important; background: rgba(239,68,68,0.06) }
    
    /* Enhanced explanation styling */
    .explanation-container { margin-top: 12px; padding: 12px; border-radius: 8px; background: rgba(30, 41, 59, 0.4); }
    .result-status { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600;}
    .correct-status { color: var(--accent); }
    .wrong-status { color: var(--danger); }
    .unanswered-status { color: #facc15; } 
    .explain{ color:#cbd5e1; font-size:14px; opacity:0.95; margin: 0; }

    /* User profile */
    .user-profile { display: flex; align-items: center; gap: 10px; margin-left: auto; }
    .user-avatar { width: 36px; height: 36px; border-radius: 50%; border: 2px solid var(--accent); }
    .user-name { font-weight: 600; color: var(--text); }
    .user-points { background: linear-gradient(135deg, #f59e0b, #fbbf24); color: #1e1b1b; padding: 2px 8px; border-radius: 9999px; font-weight: 700; font-size: 12px; }

    /* Ranking table */
    .ranking-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card); border: 1px solid rgba(148,163,184,0.2); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); z-index: 100; width: 90%; max-width: 700px; max-height: 80vh; overflow-y: auto; display: none; }
    .ranking-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid rgba(148,163,184,0.2); }
    .ranking-title { font-weight: 700; font-size: 18px; }
    .ranking-close { background: none; border: none; color: var(--text); font-size: 20px; cursor: pointer; }
    .ranking-search { padding: 12px 20px; border-bottom: 1px solid rgba(148,163,184,0.2); }
    .ranking-search input { width: 100%; padding: 10px 14px; border-radius: 10px; background: #0b1220; border: 1px solid rgba(148,163,184,0.2); color: var(--text); }
    .ranking-table { width: 100%; border-collapse: collapse; }
    .ranking-table th, .ranking-table td { padding: 12px 16px; text-align: left; border-bottom: 1px solid rgba(148,163,184,0.1); }
    .ranking-table th { background: rgba(30, 41, 59, 0.4); font-weight: 600; }
    .ranking-table tr:hover { background: rgba(30, 41, 59, 0.2); }
    .ranking-user-rank { font-weight: 700; color: var(--accent); text-align: center; padding: 16px; background: rgba(34,197,94,0.1); }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 99; display: none; }

    .hidden{ display:none !important }
    .mute{ color: var(--muted) }
    .footer-note{ text-align:center; color:var(--muted); margin: 16px 0 40px; font-size:13px }
    .score-badge{ font-weight:800; color:#052e16; background:linear-gradient(180deg, #86efac, #22c55e); border-radius:9999px; padding:6px 12px; border:1px solid var(--accent-weak) }
    
    .back-button {
        display: inline-block;
        margin: 30px auto;
        padding: 12px 30px;
        background: linear-gradient(135deg, #2c3e50 0%, #4a6491 100%);
        color: white;
        text-decoration: none;
        border-radius: 50px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        max-width: 200px;
        justify-content: center;
    }
    
    .back-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        background: linear-gradient(135deg, #4a6491 0%, #2c3e50 100%);
    }
    
    .button-container {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
    }
    
    @media (max-width:640px){ 
        .q-head{ flex-direction:column; }
        .button-container { flex-direction: column; align-items: center; }
        .header-inner { flex-wrap: wrap; }
        .controls { order: 3; width: 100%; justify-content: center; margin-top: 10px; }
        .user-profile { order: 2; margin-left: auto; }
        .ranking-table th, .ranking-table td { padding: 8px 10px; font-size: 14px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner container">
      <div class="brand">📚 Vocabulary MCQ Exam</div>
      <span class="pill">10 Questions • 10 Minutes • +1 / −0.25 / 0</span>
      <div id="timer" class="timer" aria-live="polite">10:00</div>
      <div class="controls">
        <button id="startBtn" class="primary">Start Exam</button>
        <button id="resetBtn" title="Start a new exam">New Exam</button>
        <button id="rankingBtn">Ranking</button>
      </div>
      <div id="userProfile" class="user-profile hidden">
        <img id="userAvatar" class="user-avatar" src="" alt="User Avatar">
        <div>
          <div id="userName" class="user-name"></div>
          <div id="userPoints" class="user-points">0 pts</div>
        </div>
      </div>
      <div id="signInButton" class="g-signin2" data-theme="dark"></div>
    </div>
  </header>

  <main class="container">
    <section class="card intro" id="intro">
      <h2 style="margin:0 0 6px">Instructions</h2>
      <ul>
        <li>10 questions will be drawn randomly from the full pool.</li>
        <li>All questions are on <strong>Vocabulary (English to Bengali, Bengali to English, Synonyms, Antonyms)</strong>.</li>
        <li>Scoring: Correct +1, Wrong −0.25, Unanswered 0.</li>
        <li>Time limit: 10 minutes. Auto-submit when time ends.</li>
        <li>All questions appear on one page — scroll to navigate.</li>
        <li>Sign in with Google to save your progress and appear in rankings.</li>
      </ul>
    </section>

    <div id="summary" class="card result hidden" role="status" aria-live="polite"></div>

    <form id="exam" class="card" autocomplete="off"></form>

    <div class="actions">
      <div class="legend">
        <span><span class="dot correct"></span> Correct</span>
        <span><span class="dot wrong"></span> Wrong</span>
        <span><span class="dot unanswered"></span> Unanswered</span>
      </div>
      <button id="submitBtn" class="primary" disabled>Submit Exam</button>
    </div>
    
    <div class="button-container">
        <a href='index.html' class='back-button'>
            <i class="fas fa-arrow-left"></i> Back to Home
        </a>
        <a href='mcq_of.html' class='back-button'>
            <i class="fas fa-arrow-left"></i> Back to Previous Page
        </a>
    </div>
  </main>

  <!-- Ranking Modal -->
  <div class="overlay" id="rankingOverlay"></div>
  <div class="ranking-container" id="rankingContainer">
    <div class="ranking-header">
      <div class="ranking-title">Global Ranking</div>
      <button class="ranking-close" id="closeRanking">&times;</button>
    </div>
    <div class="ranking-search">
      <input type="text" id="searchRanking" placeholder="Search by name...">
    </div>
    <div id="userRank" class="ranking-user-rank hidden">Your Rank: #<span id="rankNumber"></span></div>
    <div class="ranking-table-container">
      <table class="ranking-table">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Name</th>
            <th>Score</th>
            <th>Exams Taken</th>
          </tr>
        </thead>
        <tbody id="rankingTableBody">
          <!-- Ranking data will be inserted here -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
  // ----------------------------
  // Utilities
  // ----------------------------
  const EXAM_SIZE = 10;
  const EXAM_MINUTES = 10; // minutes
  const STORAGE_KEY = 'vocabulary_exam_state_v1';
  const USERS_STORAGE_KEY = 'vocabulary_users_v1';

  const qs = (sel, el=document) => el.querySelector(sel);
  const qsa = (sel, el=document) => [...el.querySelectorAll(sel)];
  const pick = (arr, n) => {
    const a = [...arr];
    for (let i=a.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
    return a.slice(0, n);
  };

  function formatTime(s){
    const m = Math.floor(s/60).toString().padStart(2,'0');
    const r = Math.floor(s%60).toString().padStart(2,'0');
    return `${m}:${r}`;
  }

  function saveState(state){ sessionStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function loadState(){ try{ return JSON.parse(sessionStorage.getItem(STORAGE_KEY)||'null'); }catch{return null} }
  function clearState(){ sessionStorage.removeItem(STORAGE_KEY); }

  // ----------------------------
  // User Management
  // ----------------------------
  function saveUser(userData) {
    const users = getUsers();
    const existingUserIndex = users.findIndex(u => u.id === userData.id);
    
    if (existingUserIndex !== -1) {
      // Update existing user
      users[existingUserIndex] = userData;
    } else {
      // Add new user
      users.push(userData);
    }
    
    localStorage.setItem(USERS_STORAGE_KEY, JSON.stringify(users));
    return userData;
  }

  function getUsers() {
    try {
      return JSON.parse(localStorage.getItem(USERS_STORAGE_KEY) || '[]');
    } catch {
      return [];
    }
  }

  function getUserById(id) {
    const users = getUsers();
    return users.find(u => u.id === id);
  }

  function updateUserScore(userId, score) {
    const users = getUsers();
    const userIndex = users.findIndex(u => u.id === userId);
    
    if (userIndex !== -1) {
      users[userIndex].totalScore = (users[userIndex].totalScore || 0) + score;
      users[userIndex].examsTaken = (users[userIndex].examsTaken || 0) + 1;
      localStorage.setItem(USERS_STORAGE_KEY, JSON.stringify(users));
      return users[userIndex];
    }
    
    return null;
  }

  function getRankings() {
    const users = getUsers();
    return users
      .filter(user => user.totalScore !== undefined)
      .sort((a, b) => b.totalScore - a.totalScore)
      .map((user, index) => ({ ...user, rank: index + 1 }));
  }

  // ----------------------------
  // Google Sign-in
  // ----------------------------
  function onGoogleSignIn(googleUser) {
    const profile = googleUser.getBasicProfile();
    const userData = {
      id: profile.getId(),
      name: profile.getName(),
      avatar: profile.getImageUrl(),
      email: profile.getEmail(),
      totalScore: 0,
      examsTaken: 0
    };

    // Check if user already exists and preserve their score
    const existingUser = getUserById(userData.id);
    if (existingUser) {
      userData.totalScore = existingUser.totalScore || 0;
      userData.examsTaken = existingUser.examsTaken || 0;
    }

    // Save user data
    saveUser(userData);

    // Update UI
    qs('#userAvatar').src = userData.avatar;
    qs('#userName').textContent = userData.name;
    qs('#userPoints').textContent = `${userData.totalScore} pts`;
    qs('#userProfile').classList.remove('hidden');
    qs('#signInButton').classList.add('hidden');

    // Store current user in session
    sessionStorage.setItem('currentUser', JSON.stringify(userData));
  }

  function signOut() {
    const auth2 = gapi.auth2.getAuthInstance();
    auth2.signOut().then(() => {
      qs('#userProfile').classList.add('hidden');
      qs('#signInButton').classList.remove('hidden');
      sessionStorage.removeItem('currentUser');
    });
  }

  // Check if user is already signed in
  function checkSignedIn() {
    const auth2 = gapi.auth2.getAuthInstance();
    auth2.then(() => {
      if (auth2.isSignedIn.get()) {
        const googleUser = auth2.currentUser.get();
        onGoogleSignIn(googleUser);
      }
    });
  }

  // ----------------------------
  // Ranking System
  // ----------------------------
  function showRanking() {
    const rankings = getRankings();
    const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || 'null');
    const tableBody = qs('#rankingTableBody');
    
    // Clear previous data
    tableBody.innerHTML = '';
    
    // Filter rankings based on search
    const searchTerm = qs('#searchRanking').value.toLowerCase();
    const filteredRankings = rankings.filter(user => 
      user.name.toLowerCase().includes(searchTerm)
    );
    
    // Populate table
    filteredRankings.forEach((user, index) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${user.rank}</td>
        <td><img src="${user.avatar}" style="width:24px;height:24px;border-radius:50%;margin-right:8px;vertical-align:middle">${user.name}</td>
        <td>${user.totalScore}</td>
        <td>${user.examsTaken || 0}</td>
      `;
      
      // Highlight current user
      if (currentUser && user.id === currentUser.id) {
        row.style.background = 'rgba(34,197,94,0.1)';
        qs('#userRank').classList.remove('hidden');
        qs('#rankNumber').textContent = user.rank;
      }
      
      tableBody.appendChild(row);
    });
    
    // Show ranking modal
    qs('#rankingContainer').style.display = 'block';
    qs('#rankingOverlay').style.display = 'block';
  }

  function hideRanking() {
    qs('#rankingContainer').style.display = 'none';
    qs('#rankingOverlay').style.display = 'none';
  }

  // ----------------------------
  // Question Pool (Vocabulary)
  // Each question: { id, q, options:[], answer: index, explain }
  // ----------------------------
  const QUESTIONS = [
    {
      id: 1,
      q: "Choose the Bengali meaning of: 'ubiquitous'",
      options: ["বিরল", "সর্বত্র বিদ্যমান", "গোপন", "অকার্যকর"],
      answer: 1,
      explain: "ব্যাখ্যা: 'Ubiquitous' শব্দের অর্থ হলো 'সর্বত্র বিদ্যমান'। উদাহরণস্বরূপ, আজকাল স্মার্টফোনগুলি সর্বত্র বিদ্যমান (ubiquitous)।"
    },
    {
      id: 2,
      q: "Choose the English meaning of: 'পরিপক্ব'",
      options: ["Immature", "Mature", "Young", "New"],
      answer: 1,
      explain: "ব্যাখ্যা: 'পরিপক্ব' শব্দের ইংরেজি অর্থ হলো 'Mature' যা পূর্ণবিকশিত বা পরিণত বোঝায়।"
    },
    {
      id: 3,
      q: "Choose the synonym of: 'Benevolent'",
      options: ["Cruel", "Kind", "Stingy", "Selfish"],
      answer: 1,
      explain: "ব্যাখ্যা: 'Benevolent' শব্দের প্রতিশব্দ হলো 'Kind' যা দয়ালু বা পরোপকারী বোঝায়।"
    },
    {
      id: 4,
      q: "Choose the antonym of: 'Courage'",
      options: ["Bravery", "Fear", "Confidence", "Daring"],
      answer: 1,
      explain: "ব্যাখ্যা: 'Courage' শব্দের বিপরীত শব্দ হলো 'Fear' যা ভয় বা সাহসের অভাব বোঝায়।"
    },
    {
      id: 5,
      q: "Choose the Bengali meaning of: 'Perseverance'",
      options: ["হতাশা", "অধ্যবসায়", "আলস্য", "বিরক্তি"],
      answer: 1,
      explain: "ব্যাখ্যা: 'Perseverance' শব্দের বাংলা অর্থ হলো 'অধ্যবসায়' যা কোনো কাজে লাগাতার চেষ্টা চালিয়ে যাওয়া বোঝায়।"
    },
    {
      id: 6,
      q: "Choose the English meaning of: 'সহানুভূতি'",
      options: ["Apathy", "Sympathy", "Antipathy", "Empathy"],
      answer: 3,
      explain: "ব্যাখ্যা: 'সহানুভূতি' শব্দের সঠিক ইংরেজি প্রতিশব্দ হলো 'Empathy' যা অন্য মানুষের অনুভূতি বুঝতে পারা এবং সেগুলোতে সাড়া দেওয়া বোঝায়।"
    },
    {
      id: 7,
      q: "Choose the synonym of: 'Magnificent'",
      options: ["Ordinary", "Splendid", "Simple", "Plain"],
      answer: 1,
      explain: "ব্যাখ্যা: 'Magnificent' শব্দের প্রতিশব্দ হলো 'Splendid' যা চমৎকার, মহান বা জাঁকজমকপূর্ণ বোঝায়।"
    },
    {
      id: 8,
      q: "Choose the antonym of: 'Generous'",
      options: ["Charitable", "Stingy", "Kind", "Benevolent"],
      answer: 1,
      explain: "ব্যাখ্যা: 'Generous' শব্দের বিপরীত শব্দ হলো 'Stingy' যা কৃপণ বা অর্থ/সময়/সম্পদ দেওয়ার ক্ষেত্রে অনিচ্ছুক বোঝায়।"
    },
    {
      id: 9,
      q: "Choose the Bengali meaning of: 'Ambiguous'",
      options: ["স্পষ্ট", "অস্পষ্ট", "নিশ্চিত", "নির্দিষ্ট"],
      answer: 1,
      explain: "ব্যাখ্যা: 'Ambiguous' শব্দের বাংলা অর্থ হলো 'অস্পষ্ট' যা একাধিক অর্থ বহন করতে পারে এমন বা স্পষ্ট নয় এমন বোঝায়।"
    },
    {
      id: 10,
      q: "Choose the English meaning of: 'বিবেক'",
      options: ["Conscience", "Conscious", "Knowledge", "Wisdom"],
      answer: 0,
      explain: "ব্যাখ্যা: 'বিবেক' শব্দের সঠিক ইংরেজি প্রতিশব্দ হলো 'Conscience' যা নৈতিক সঠিক ও ভুলের内在 অনুভূতি বোঝায়।"
    },
    {
      id: 11,
      q: "Choose the synonym of: 'Diligent'",
      options: ["Lazy", "Hardworking", "Careless", "Negligent"],
      answer: 1,
      explain: "ব্যাখ্যা: 'Diligent' শব্দের প্রতিশব্দ হলো 'Hardworking' যা পরিশ্রমী বা কোন কাজে মনোযোগ সহকারে নিযুক্ত থাকা বোঝায়।"
    },
    {
      id: 12,
      q: "Choose the antonym of: 'Expand'",
      options: ["Grow", "Contract", "Increase", "Extend"],
      answer: 1,
      explain: "ব্যাখ্যা: 'Expand' শব্দের বিপরীত শব্দ হলো 'Contract' যা সঙ্কুচিত হওয়া বা আয়তনে/আকারে ছোট হওয়া বোঝায়।"
    },
    {
      id: 13,
      q: "Choose the Bengali meaning of: 'Resilient'",
      options: ["নমনীয়", "ভঙ্গুর", "স্থিতিস্থাপক", "দৃঢ়"],
      answer: 2,
      explain: "ব্যাখ্যা: 'Resilient' শব্দের বাংলা অর্থ হলো 'স্থিতিস্থাপক' যা কঠিন পরিস্থিতি থেকে দ্রুত পুনরুদ্ধার করতে সক্ষম বোঝায়।"
    },
    {
      id: 14,
      q: "Choose the English meaning of: 'সহিষ্ণুতা'",
      options: ["Impatience", "Tolerance", "Intolerance", "Anger"],
      answer: 1,
      explain: "ব্যাখ্যা: 'সহিষ্ণুতা' শব্দের সঠিক ইংরেজি প্রতিশব্দ হলো 'Tolerance' যা অন্য মানুষের মতামত, আচরণ বা অভ্যাস মেনে নেওয়ার গুণ বোঝায়।"
    },
    {
      id: 15,
      q: "Choose the synonym of: 'Eloquent'",
      options: ["Articulate", "Inarticulate", "Mute", "Reserved"],
      answer: 0,
      explain: "ব্যাখ্যা: 'Eloquent' শব্দের প্রতিশব্দ হলো 'Articulate' যা ভাষা ব্যবহারে সাবলীল এবং কার্যকরভাবে ধারণা প্রকাশ করতে সক্ষম বোঝায়।"
    }
  ];

  // ----------------------------
  // State
  // ----------------------------
  let selectedIds = [];
  let selectedMap = {}; // { qid: optionIndex }
  let endTime = null; // epoch seconds
  let submitted = false;
  let timerHandle = null;

  // ----------------------------
  // DOM Elements
  // ----------------------------
  const examForm = qs('#exam');
  const startBtn = qs('#startBtn');
  const resetBtn = qs('#resetBtn');
  const submitBtn = qs('#submitBtn');
  const timerEl = qs('#timer');
  const summaryEl = qs('#summary');
  const introEl = qs('#intro');
  const rankingBtn = qs('#rankingBtn');
  const closeRankingBtn = qs('#closeRanking');
  const searchRankingInput = qs('#searchRanking');
  const rankingOverlay = qs('#rankingOverlay');

  // ----------------------------
  // Rendering
  // ----------------------------
  function renderQuestions(){
    examForm.innerHTML = '';
    const chosen = QUESTIONS.filter(q=>selectedIds.includes(q.id));
    chosen.forEach((q,idx)=>{
      const qWrap = document.createElement('section');
      qWrap.className = 'question';
      qWrap.setAttribute('data-qid', q.id);

      qWrap.innerHTML = `
        <div class="q-head">
          <div class="q-num">${idx+1}</div>
          <div class="q-text">${q.q}</div>
        </div>
        <div class="options" role="radiogroup" aria-label="Question ${idx+1}">
          ${q.options.map((opt,i)=>{
            const checked = selectedMap[q.id] === i ? 'checked' : '';
            return `
              <label class="option">
                <input type="radio" name="q_${q.id}" value="${i}" ${checked} aria-label="Option ${String.fromCharCode(65+i)}">
                <div class="opt-text"><strong>(${String.fromCharCode(65+i)})</strong> ${opt}</div>
              </label>
            `;}).join('')}
        </div>
      `;

      examForm.appendChild(qWrap);
    });

    // attach listeners
    qsa('input[type=radio]', examForm).forEach(inp=>{
      inp.addEventListener('change', e=>{
        const name = e.target.name; // q_<id>
        const qid = parseInt(name.split('_')[1],10);
        selectedMap[qid] = parseInt(e.target.value,10);
        persist();
      });
    })
  }

  function renderSummary(score, details){
    const total = EXAM_SIZE;
    const correct = details.filter(d=>d.correct).length;
    const wrong = details.filter(d=>d.user!==null && !d.correct).length;
    const unanswered = total - correct - wrong;

    summaryEl.classList.remove('hidden');
    summaryEl.innerHTML = `
      <div style="display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap">
        <div style="display:flex; gap:12px; align-items:center">
          <span class="score-badge" title="Final Score">Score: ${score.toFixed(2)} / ${total.toFixed(2)}</span>
          <span class="chip correct-chip">✅ ${correct} correct</span>
          <span class="chip wrong-chip">❌ ${wrong} wrong</span>
          <span class="chip unanswered-chip">⏳ ${unanswered} unanswered</span>
        </div>
        <button onclick="window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'})"> Go to Bottom</button>
      </div>
    `;
  }

  function markReview(details){
    // Color options + show explanations
    details.forEach((d,idx)=>{
      const sec = qs(`.question[data-qid="${d.id}"]`);
      if(!sec) return;
      const labels = qsa('.option', sec);
      labels.forEach((lab,i)=>{
        lab.classList.remove('correct','wrong');
        if(i===d.answer) lab.classList.add('correct');
        if(d.user!==null && i===d.user && !d.correct) lab.classList.add('wrong');
        lab.querySelector('input').disabled = true;
      });
      
      // Create explanation container with correct/wrong status
      const expContainer = document.createElement('div');
      expContainer.className = 'explanation-container';
      
      // Add correct/wrong status with icons
      const statusDiv = document.createElement('div');
      statusDiv.className = `result-status ${d.correct ? 'correct-status' : 'wrong-status'}`;
      
       if (d.correct) {
        statusDiv.className = 'result-status correct-status';
        statusDiv.innerHTML = `<i class="fas fa-check-circle"></i> Correct`;
      } else if (d.user !== null) {
        statusDiv.className = 'result-status wrong-status';
        statusDiv.innerHTML = `<i class="fas fa-times-circle"></i> Wrong`;
      } else {
        statusDiv.className = 'result-status unanswered-status';
        statusDiv.innerHTML = `<i class="fas fa-question-circle"></i> Unanswered`;
      }
      
      // Add explanation text
      const exp = document.createElement('p');
      exp.className = 'explain';
      exp.textContent = d.explain;
      
      // Append elements to container
      expContainer.appendChild(statusDiv);
      expContainer.appendChild(exp);
      
      // Append container to question section
      sec.appendChild(expContainer);
    });
  }

  // ----------------------------
  // Exam Flow
  // ----------------------------
  function startExam(){
    if(selectedIds.length===0){
      selectedIds = pick(QUESTIONS, EXAM_SIZE).map(q=>q.id);
    }
    endTime = Math.floor(Date.now()/1000) + EXAM_MINUTES*60;
    submitted = false;
    submitBtn.disabled = false;
    introEl.classList.add('hidden');
    summaryEl.classList.add('hidden');
    renderQuestions();
    persist();
    startTimer();
  }

  function submitExam(reason='manual'){
    if(submitted) return;
    submitted = true;
    stopTimer();
    submitBtn.disabled = true;

    const chosen = QUESTIONS.filter(q=>selectedIds.includes(q.id));
    const details = chosen.map(q=>{
      const user = (q.id in selectedMap) ? selectedMap[q.id] : null;
      const correct = user===q.answer;
      return { id:q.id, user, answer:q.answer, correct, explain:q.explain };
    });

    const correctCount = details.filter(d=>d.correct).length;
    const wrongCount = details.filter(d=>d.user!==null && !d.correct).length;
    const score = correctCount*1 + wrongCount*(-0.25);

    renderSummary(score, details);
    markReview(details);

    // Update user score if signed in
    const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || 'null');
    if (currentUser) {
      const updatedUser = updateUserScore(currentUser.id, score);
      if (updatedUser) {
        qs('#userPoints').textContent = `${updatedUser.totalScore} pts`;
        sessionStorage.setItem('currentUser', JSON.stringify(updatedUser));
      }
    }

    // lock state
    persist();
  }

  function resetExam(){
    stopTimer();
    clearState();
    selectedIds = [];
    selectedMap = {};
    endTime = null;
    submitted = false;
    timerEl.textContent = formatTime(EXAM_MINUTES*60);
    submitBtn.disabled = true;
    summaryEl.classList.add('hidden');
    examForm.innerHTML = '';
    introEl.classList.remove('hidden');
    window.scrollTo({top:0,behavior:'smooth'});
  }

  // ----------------------------
  // Timer
  // ----------------------------
  function startTimer(){
    stopTimer();
    tick();
    timerHandle = setInterval(tick, 1000);
  }
  function stopTimer(){ if(timerHandle){ clearInterval(timerHandle); timerHandle=null; } }
  function tick(){
    const now = Math.floor(Date.now()/1000);
    const remain = Math.max(0, endTime - now);
    timerEl.textContent = formatTime(remain);

    // color hints
    if(remain <= 60){ timerEl.style.background = '#2b0b0b'; timerEl.style.color = '#fecaca'; timerEl.style.borderColor = 'rgba(248,113,113,0.4)'; }
    else if(remain <= 5*60){ timerEl.style.background = '#2b1a0b'; timerEl.style.color = '#fde68a'; timerEl.style.borderColor = 'rgba(245,158,11,0.4)'; }

    if(remain===0){ submitExam('timeout'); }
  }

  // ----------------------------
  // Persistence (sessionStorage)
  // ----------------------------
  function persist(){
    const state = { selectedIds, selectedMap, endTime, submitted };
    saveState(state);
  }
  function restore(){
    const state = loadState();
    if(!state) return;
    selectedIds = state.selectedIds||[];
    selectedMap = state.selectedMap||{};
    endTime = state.endTime||null;
    submitted = !!state.submitted;

    if(selectedIds.length){
      introEl.classList.add('hidden');
      renderQuestions();
      if(submitted){
        // rebuild review
        const chosen = QUESTIONS.filter(q=>selectedIds.includes(q.id));
        const details = chosen.map(q=>{
          const user = (q.id in selectedMap) ? selectedMap[q.id] : null;
          const correct = user===q.answer;
          return { id:q.id, user, answer:q.answer, correct, explain:q.explain };
        });
        const correctCount = details.filter(d=>d.correct).length;
        const wrongCount = details.filter(d=>d.user!==null && !d.correct).length;
        const score = correctCount*1 + wrongCount*(-0.25);
        submitBtn.disabled = true;
        renderSummary(score, details);
        markReview(details);
      } else if(endTime){
        submitBtn.disabled = false;
        startTimer();
      }
    }
  }

  // ----------------------------
  // Wiring
  // ----------------------------
  startBtn.addEventListener('click', () => {
    if(loadState() && !submitted){ if(!confirm('Start a new attempt? Your current attempt will be replaced.')) return; }
    resetExam();
    startExam();
  });
  resetBtn.addEventListener('click', resetExam);
  submitBtn.addEventListener('click', (e)=>{ e.preventDefault(); submitExam('manual'); window.scrollTo({top:0,behavior:'smooth'}); });
  rankingBtn.addEventListener('click', showRanking);
  closeRankingBtn.addEventListener('click', hideRanking);
  rankingOverlay.addEventListener('click', hideRanking);
  searchRankingInput.addEventListener('input', showRanking);

  window.addEventListener('beforeunload', (e)=>{
    // gentle reminder if exam running
    const state = loadState();
    if(state && state.selectedIds && state.selectedIds.length && !state.submitted){
      e.preventDefault(); e.returnValue = '';
    }
  });

  // Initialize
  (function init(){
    timerEl.textContent = formatTime(EXAM_MINUTES*60);
    restore();
    
    // Check if user is already signed in
    if (typeof gapi !== 'undefined') {
      gapi.load('auth2', function() {
        gapi.auth2.init({
          client_id: 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com'
        }).then(checkSignedIn);
      });
    }
  })();
  </script>
</body>
<<<<<<< HEAD
</html>
=======
<<<<<<< HEAD
</html>
=======
</html>
>>>>>>> 830da78 (vocab_main.html added)
>>>>>>> temp-fix
