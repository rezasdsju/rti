<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vocabulary MCQ Exam</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #0f172a;
            --card: #111827;
            --muted: #94a3b8;
            --text: #e5e7eb;
            --accent: #22c55e;
            --accent-weak: #16a34a;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #60a5fa;
            --ring: rgba(34, 197, 94, 0.4);
            --primary-button: #2c3e50;
            --primary-button-hover: #4a6491;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            background: linear-gradient(180deg, #0b1220, var(--bg));
            color: var(--text);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            max-width: 950px;
            width: 100%;
            margin: 0 auto;
            padding: 0 20px;
            flex: 1;
        }

        header {
            width: 72%;
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(10px);
            background: linear-gradient(180deg, rgba(2, 6, 23, 0.92), rgba(2, 6, 23, 0.6));
            border-bottom: 1px solid rgba(148, 163, 184, 0.15);
        }

        .header-inner {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 24px;
        }

        .brand {
            font-weight: 700;
            letter-spacing: 0.3px;
        }

        .pill {
            padding: 6px 10px;
            background: #0b1324;
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 9999px;
            color: var(--muted);
            font-size: 12px;
        }

        .timer {
            margin-left: auto;
            font-variant-numeric: tabular-nums;
            font-weight: 700;
            padding: 6px 12px;
            border-radius: 10px;
            background: #0b1a2f;
            border: 1px solid rgba(96, 165, 250, 0.3);
            color: #bfdbfe;
        }
        
        .controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        button {
            background: #0b1220;
            color: var(--text);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 12px;
            padding: 10px 14px;
            cursor: pointer;
            font-weight: 600;
        }
        
        button:hover {
            border-color: rgba(148, 163, 184, 0.35);
        }

        button.primary {
            background: linear-gradient(180deg, var(--accent), var(--accent-weak));
            border-color: transparent;
            color: #052e16;
        }

        button.primary:hover {
            filter: brightness(0.98);
        }
        
        .card {
            background: #0b1220;
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.35);
        }

        .intro, .login-card {
            padding: 20px;
            margin-top: 16px;
        }
        
        .intro p {
            color: var(--muted);
            margin: 8px 0 0;
        }

        .meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 10px;
        }
        
        .meta .chip {
            font-size: 13px;
            padding: 6px 10px;
            border-radius: 8px;
            background: #091225;
            border: 1px solid rgba(148, 163, 184, 0.2);
            color: #cbd5e1;
        }

        .question {
            padding: 20px;
            border-top: 1px solid rgba(148, 163, 184, 0.12);
        }
        
        .q-head {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }
        
        .q-num {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            display: grid;
            place-content: center;
            background: #0b1a2f;
            color: #bfdbfe;
            font-weight: 700;
            border: 1px solid rgba(96, 165, 250, 0.35);
        }
        
        .q-text {
            font-weight: 600;
            line-height: 1.4;
        }

        .options {
            margin-top: 12px;
            display: grid;
            gap: 10px;
        }
        
        .option {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            border: 1px solid rgba(148, 163, 184, 0.18);
            border-radius: 12px;
            cursor: pointer;
            background: #0a1020;
        }
        
        .option:hover {
            border-color: rgba(148, 163, 184, 0.32);
        }

        .option input {
            appearance: none;
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid #93c5fd;
            margin-top: 3px;
            display: inline-grid;
            place-content: center;
            outline: none;
        }

        .option input::before {
            content: "";
            width: 10px;
            height: 10px;
            border-radius: 50%;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            background: #60a5fa;
        }
        
        .option input:checked::before {
            transform: scale(1);
        }

        .option .opt-text {
            flex: 1;
        }

        .actions {
            position: sticky;
            bottom: 0;
            background: linear-gradient(180deg, rgba(2, 6, 23, 0), rgba(2, 6, 23, 0.9) 25%, rgba(2, 6, 23, 1));
            padding: 16px 24px;
            display: flex;
            gap: 10px;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid rgba(148, 163, 184, 0.15);
        }

        .result {
            padding: 18px 20px;
            border-top: 1px solid rgba(148, 163, 184, 0.12);
            background: #081427;
        }

        .result strong {
            color: #bbf7d0;
        }
        
        .legend {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            color: var(--muted);
            font-size: 14px;
        }
        
        .legend span {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            background: #0b1324;
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 9999px;
        }
        
        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .dot.correct {
            background: var(--accent);
        }
        
        .dot.wrong {
            background: var(--danger);
        }
        
        .dot.unanswered {
            background: #facc15;
        }

        .unanswered-chip {
            color: #facc15;
            border-color: rgba(250, 204, 21, 0.4);
        }
        
        .correct-chip {
            color: #22c55e;
            border-color: rgba(34, 197, 94, 0.4);
        }

        .wrong-chip {
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.4);
        }
        
        .correct {
            border-color: rgba(34, 197, 94, 0.6) !important;
            background: rgba(34, 197, 94, 0.06);
        }
        
        .wrong {
            border-color: rgba(239, 68, 68, 0.6) !important;
            background: rgba(239, 68, 68, 0.06);
        }
        
        .explanation-container {
            margin-top: 12px;
            padding: 12px;
            border-radius: 8px;
            background: rgba(30, 41, 59, 0.4);
        }

        .result-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .correct-status {
            color: var(--accent);
        }

        .wrong-status {
            color: var(--danger);
        }

        .unanswered-status {
            color: #facc15;
        }

        .explain {
            color: #cbd5e1;
            font-size: 14px;
            opacity: 0.95;
            margin: 0;
        }

        .hidden {
            display: none !important;
        }

        .mute {
            color: var(--muted);
        }

        .footer-note {
            text-align: center;
            color: var(--muted);
            margin: 16px 0 40px;
            font-size: 13px;
        }
        
        .score-badge {
            font-weight: 800;
            color: #052e16;
            background: linear-gradient(180deg, #86efac, #22c55e);
            border-radius: 9999px;
            padding: 6px 12px;
            border: 1px solid var(--accent-weak);
        }

        .back-button {
            display: inline-flex;
            margin: 30px auto;
            padding: 12px 30px;
            background: linear-gradient(135deg, var(--primary-button) 0%, var(--primary-button-hover) 100%);
            color: white;
            text-decoration: none;
            border-radius: 50px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: none;
            cursor: pointer;
            align-items: center;
            gap: 10px;
            max-width: 200px;
            justify-content: center;
        }

        .back-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, var(--primary-button-hover) 0%, var(--primary-button) 100%);
        }

        .button-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        /* Login and Ranking Styles */
        .login-card {
            display: flex;
            flex-direction: column;
            gap: 16px;
            align-items: center;
            max-width: 400px;
            margin: 2rem auto;
            text-align: center;
        }

        .login-card input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--muted);
            background: var(--card);
            color: var(--text);
            font-size: 16px;
            text-align: center;
        }

        .login-card input:focus {
            outline: 2px solid var(--info);
            border-color: var(--info);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--info);
            font-weight: 600;
            padding: 8px 12px;
            border-radius: 12px;
            background: rgba(96, 165, 250, 0.1);
            border: 1px solid rgba(96, 165, 250, 0.3);
        }

        .ranking-container {
            max-width: 600px;
            margin: 2rem auto;
            padding: 20px;
            border-radius: 16px;
            background: var(--card);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.35);
        }

        .ranking-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .ranking-table th, .ranking-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        .ranking-table th {
            background: rgba(148, 163, 184, 0.05);
            font-weight: 600;
            color: var(--text);
        }

        .ranking-table tr.current-user {
            background: rgba(34, 197, 94, 0.1);
            font-weight: 700;
        }
        
        #user-rank-display {
            font-size: 14px;
            padding: 6px 10px;
            background: rgba(96, 165, 250, 0.2);
            border-radius: 8px;
            margin-top: 10px;
            text-align: center;
        }

        @media (max-width:640px) {
            .q-head {
                flex-direction: column;
            }

            .button-container {
                flex-direction: column;
                align-items: center;
            }

            header {
                width: 100%;
            }

            .header-inner {
                padding: 10px 16px;
                flex-wrap: wrap;
                justify-content: center;
            }

            .controls {
                margin-top: 8px;
                width: 100%;
                justify-content: center;
            }

            .timer {
                margin-left: 0;
                order: -1;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-inner container">
            <div class="brand">📝 Vocabulary MCQ Exam</div>
            <span class="pill">10 Questions • 10 Minutes • +1 / −0.25 / 0</span>
            <div id="user-info-display" class="hidden user-info"></div>
            <div id="timer" class="timer" aria-live="polite">10:00</div>
            <div class="controls">
                <button id="startBtn" class="primary">Start Exam</button>
                <button id="resetBtn" title="Start a new exam">New Exam</button>
                <button id="rankingBtn">Ranking</button>
            </div>
        </div>
    </header>

    <main class="container">
        <section class="card login-card" id="login-section">
            <i class="fas fa-user-circle fa-4x mute"></i>
            <h2 style="margin:0;">Welcome!</h2>
            <p class="mute">Please enter your name to start the exam and track your progress.</p>
            <input type="text" id="username-input" placeholder="Enter your name" required />
            <button id="save-username-btn" class="primary" style="width:100%">Save and Continue</button>
        </section>

        <section class="card intro hidden" id="intro">
            <h2 style="margin:0 0 6px">Instructions</h2>
            <ul>
                <li>10 questions will be drawn randomly from the full pool.</li>
                <li>All questions are on <strong>Vocabulary (English to Bengali / Bengali to English)</strong>.</li>
                <li>Scoring: Correct +1, Wrong −0.25, Unanswered 0.</li>
                <li>Time limit: 10 minutes. Auto-submit when time ends.</li>
                <li>All questions appear on one page — scroll to navigate.</li>
            </ul>
        </section>

        <section id="ranking-section" class="card ranking-container hidden">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 style="margin:0;">Global Ranking</h2>
                <span id="user-rank-display" class="hidden"></span>
            </div>
            <table class="ranking-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Name</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody id="ranking-table-body">
                </tbody>
            </table>
        </section>
        
        <div id="summary" class="card result hidden" role="status" aria-live="polite"></div>

        <form id="exam" class="card hidden" autocomplete="off"></form>

        <div class="actions hidden">
            <div class="legend">
                <span><span class="dot correct"></span> Correct</span>
                <span><span class="dot wrong"></span> Wrong</span>
                <span><span class="dot unanswered"></span> Unanswered</span>
            </div>
            <button id="submitBtn" class="primary" disabled>Submit Exam</button>
        </div>

        <div class="button-container hidden">
            <a href='index.html' class='back-button'>
                <i class="fas fa-arrow-left"></i> Back to Home
            </a>
            <a href='mcq_of.html' class='back-button'>
                <i class="fas fa-arrow-left"></i> Back to Previous Page
            </a>
        </div>
    </main>

    <script>
        // ----------------------------
        // Utilities & Constants
        // ----------------------------
        const EXAM_SIZE = 10;
        const EXAM_MINUTES = 10;
        const STATE_KEY = 'vocabulary_exam_state_v2';
        const USER_KEY = 'vocabulary_user_data_v1';
        const RANKING_KEY = 'vocabulary_ranking_data_v1';

        const qs = (sel, el = document) => el.querySelector(sel);
        const qsa = (sel, el = document) => [...el.querySelectorAll(sel)];
        
        function pick(arr, n) {
            const a = [...arr];
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a.slice(0, n);
        }

        function formatTime(s) {
            const m = Math.floor(s / 60).toString().padStart(2, '0');
            const r = Math.floor(s % 60).toString().padStart(2, '0');
            return `${m}:${r}`;
        }

        function saveState(state) {
            sessionStorage.setItem(STATE_KEY, JSON.stringify(state));
        }

        function loadState() {
            try {
                return JSON.parse(sessionStorage.getItem(STATE_KEY) || 'null');
            } catch {
                return null;
            }
        }

        function clearState() {
            sessionStorage.removeItem(STATE_KEY);
        }
        
        function saveUserData(user) {
            localStorage.setItem(USER_KEY, JSON.stringify(user));
        }

        function loadUserData() {
            try {
                return JSON.parse(localStorage.getItem(USER_KEY) || 'null');
            } catch {
                return null;
            }
        }

        function saveRankingData(ranking) {
            localStorage.setItem(RANKING_KEY, JSON.stringify(ranking));
        }

        function loadRankingData() {
            try {
                return JSON.parse(localStorage.getItem(RANKING_KEY) || '[]');
            } catch {
                return [];
            }
        }

        // ----------------------------
        // Question Pool (Synonym/Antonym/Translation)
        // Each question: { id, q, options:[], answer: index, explain }
        // ----------------------------
        const QUESTIONS = [
            { id: 1, q: "Choose the Bengali meaning of: 'ubiquitous'", options: ["বিরল", "দুর্বল", "অদৃশ্য", "সর্বত্র বিদ্যমান"], answer: 3, explain: "Ubiquitous (সর্বত্র বিদ্যমান) অর্থ হল এমন কিছু যা একই সময়ে সর্বত্র বিদ্যমান বা পাওয়া যায়। যেমন: স্মার্টফোন এখন সর্বত্র বিদ্যমান। সঠিক উত্তরটি হলো 'সর্বত্র বিদ্যমান'।" },
            { id: 2, q: "Choose the Bengali meaning of: 'ephemeral'", options: ["চিরন্তন", "দীর্ঘস্থায়ী", "ক্ষণস্থায়ী", "গুরুত্বপূর্ণ"], answer: 2, explain: "Ephemeral (ক্ষণস্থায়ী) অর্থ হলো অল্প সময়ের জন্য টিকে থাকা বা ক্ষণস্থায়ী। এটি 'চিরন্তন' এর বিপরীত শব্দ। সঠিক উত্তরটি হলো 'ক্ষণস্থায়ী'।" },
            { id: 3, q: "Choose the Synonym of 'prolific'", options: ["Unproductive", "Barren", "Fertile", "Sparse"], answer: 2, explain: "Prolific (প্রচুর উৎপাদনশীল) এর প্রতিশব্দ হলো Fertile (উর্বর)। অন্যান্য শব্দগুলো হলো এর বিপরীত শব্দ।" },
            { id: 4, q: "Choose the Antonym of 'benevolent'", options: ["Generous", "Kind", "Malevolent", "Charitable"], answer: 2, explain: "Benevolent (বদান্য, পরোপকারী) এর বিপরীত শব্দ হলো Malevolent (অহিতকারী, বিদ্বেষপরায়ণ)। অন্যান্য শব্দগুলো হলো এর প্রতিশব্দ।" },
            { id: 5, q: "Choose the Bengali meaning of 'pristine'", options: ["দূষিত", "ক্ষতিগ্রস্ত", "অস্পর্শিত", "পুরাতন"], answer: 2, explain: "Pristine (অস্পর্শিত, আদিম) অর্থ হলো তার মূল অবস্থায় থাকা, যা এখনও দূষিত বা ক্ষতিগ্রস্ত হয়নি। সঠিক উত্তরটি হলো 'অস্পর্শিত'।" },
            { id: 6, q: "Choose the synonym of 'gregarious'", options: ["Introverted", "Sociable", "Reserved", "Solitary"], answer: 1, explain: "Gregarious (দলবদ্ধভাবে থাকতে ভালোবাসে এমন) এর প্রতিশব্দ হলো Sociable (সামাজিক)।" },
            { id: 7, q: "Choose the Antonym of 'elusive'", options: ["Mysterious", "Evasive", "Definitive", "Tangible"], answer: 3, explain: "Elusive (দুর্লভ, সহজে ধরা বা বোঝা যায় না এমন) এর বিপরীত শব্দ হলো Tangible (স্পর্শযোগ্য, বাস্তব)।" },
            { id: 8, q: "Choose the Bengali meaning of 'meticulous'", options: ["অযত্নশীল", "ভুলপূর্ণ", "সতর্ক", "অগোছালো"], answer: 2, explain: "Meticulous (খুঁতখুঁতে, সতর্ক) অর্থ হলো সবকিছুর প্রতি খুব সতর্ক ও যত্নবান হওয়া। সঠিক উত্তরটি হলো 'সতর্ক'।" },
            { id: 9, q: "Choose the synonym of 'ostentatious'", options: ["Modest", "Simple", "Unassuming", "Flamboyant"], answer: 3, explain: "Ostentatious (আড়ম্বরপূর্ণ, জাঁকজমকপূর্ণ) এর প্রতিশব্দ হলো Flamboyant (উৎকট, জাঁকজমকপূর্ণ)।" },
            { id: 10, q: "Choose the Bengali meaning of 'cacophony'", options: ["মধুর সুর", "শান্তি", "কর্ণকটু শব্দ", "নিস্তব্ধতা"], answer: 2, explain: "Cacophony (কর্ণকটু শব্দ) অর্থ হলো একাধিক অপ্রীতিকর বা বেসুরো শব্দের মিশ্রণ। সঠিক উত্তরটি হলো 'কর্ণকটু শব্দ'।" },
            { id: 11, q: "Choose the Bengali meaning of 'transient'", options: ["দীর্ঘস্থায়ী", "স্থায়ী", "দ্রুতগামী", "ক্ষণস্থায়ী"], answer: 3, explain: "Transient (ক্ষণস্থায়ী) অর্থ হলো খুব অল্প সময়ের জন্য থাকা। এটি 'স্থায়ী' বা 'দীর্ঘস্থায়ী' এর বিপরীত। সঠিক উত্তরটি হলো 'ক্ষণস্থায়ী'।" },
            { id: 12, q: "Choose the Antonym of 'incessant'", options: ["Constant", "Intermittent", "Continuous", "Unceasing"], answer: 1, explain: "Incessant (অবিরাম) এর বিপরীত শব্দ হলো Intermittent (সবিরাম, থেমে থেমে)।" },
            { id: 13, q: "Choose the Bengali meaning of 'perfunctory'", options: ["যত্নশীল", "সাবধানী", "দায়সারা গোছের", "পরিশ্রমী"], answer: 2, explain: "Perfunctory (দায়সারা গোছের) অর্থ হলো কোনো কিছুতে সামান্য চেষ্টা বা যত্ন দিয়ে করা। সঠিক উত্তরটি হলো 'দায়সারা গোছের'।" },
            { id: 14, q: "Choose the synonym of 'vacillate'", options: ["Decide", "Hesitate", "Resolve", "Persist"], answer: 1, explain: "Vacillate (দ্বিধা করা) এর প্রতিশব্দ হলো Hesitate (দ্বিধা করা)।" },
            { id: 15, q: "Choose the Bengali meaning of 'abundant'", options: ["অপ্রচুর", "প্রচুর", "সীমিত", "বিরল"], answer: 1, explain: "Abundant (প্রচুর) অর্থ হলো প্রচুর পরিমাণে বিদ্যমান থাকা। সঠিক উত্তরটি হলো 'প্রচুর'।" },
            { id: 16, q: "Choose the Antonym of 'mitigate'", options: ["Lessen", "Aggravate", "Alleviate", "Ease"], answer: 1, explain: "Mitigate (প্রশমিত করা, কমানো) এর বিপরীত শব্দ হলো Aggravate (খারাপ করা, বৃদ্ধি করা)।" },
            { id: 17, q: "Choose the Bengali meaning of 'placate'", options: ["শান্ত করা", "উত্তেজিত করা", "বিরক্ত করা", "দুঃখিত করা"], answer: 0, explain: "Placate (শান্ত করা) অর্থ হলো কাউকে খুশি বা শান্ত করা যাতে তারা কম রাগান্বিত হয়। সঠিক উত্তরটি হলো 'শান্ত করা'।" },
            { id: 18, q: "Choose the synonym of 'obfuscate'", options: ["Clarify", "Simplify", "Confuse", "Illuminat"], answer: 2, explain: "Obfuscate (অস্পষ্ট করা, বিভ্রান্ত করা) এর প্রতিশব্দ হলো Confuse (বিভ্রান্ত করা)।" },
            { id: 19, q: "Choose the Bengali meaning of 'esoteric'", options: ["সাধারণ", "সহজে বোধগম্য", "দুর্লভ", "গোপন জ্ঞান"], answer: 3, explain: "Esoteric (গোপন জ্ঞান) অর্থ হলো এমন কিছু যা শুধুমাত্র অল্প সংখ্যক লোকের কাছে পরিচিত বা বোঝা যায়। সঠিক উত্তরটি হলো 'গোপন জ্ঞান'।" },
            { id: 20, q: "Choose the Antonym of 'admonish'", options: ["Approve", "Praise", "Warn", "Rebuke"], answer: 1, explain: "Admonish (ভর্ৎসনা করা, সতর্ক করা) এর বিপরীত শব্দ হলো Praise (প্রশংসা করা)।" },
            { id: 21, q: "Choose the Bengali meaning of 'deleterious'", options: ["উপকারী", "ক্ষতিকর", "গুরুত্বপূর্ণ", "সচেতন"], answer: 1, explain: "Deleterious (ক্ষতিকর) অর্থ হলো স্বাস্থ্যের জন্য ক্ষতিকর বা বিপজ্জনক। সঠিক উত্তরটি হলো 'ক্ষতিকর'।" },
            { id: 22, q: "Choose the synonym of 'ameliorate'", options: ["Worsen", "Improve", "Deteriorate", "Harm"], answer: 1, explain: "Ameliorate (উন্নতি করা) এর প্রতিশব্দ হলো Improve (উন্নতি করা)।" },
            { id: 23, q: "Choose the Bengali meaning of 'prosaic'", options: ["কাব্যিক", "সাধারণ", "উৎসাহপূর্ণ", "অসাধারণ"], answer: 1, explain: "Prosaic (সাধারণ, গতানুগতিক) অর্থ হলো কল্পনাশক্তি বা আসলত্ব বিহীন। সঠিক উত্তরটি হলো 'সাধারণ'।" },
            { id: 24, q: "Choose the Antonym of 'repudiate'", options: ["Reject", "Disavow", "Embrace", "Renounce"], answer: 2, explain: "Repudiate (প্রত্যাখ্যান করা, অস্বীকার করা) এর বিপরীত শব্দ হলো Embrace (গ্রহণ করা)।" },
            { id: 25, q: "Choose the Bengali meaning of 'alacrity'", options: ["বিরক্তি", "ধীরতা", "উৎসাহ", "হতাশা"], answer: 2, explain: "Alacrity (উৎসাহ) অর্থ হলো দ্রুত ও আগ্রহের সাথে কাজ করার ইচ্ছা। সঠিক উত্তরটি হলো 'উৎসাহ'।" },
            { id: 26, q: "Choose the synonym of 'indolent'", options: ["Lazy", "Active", "Energetic", "Industrious"], answer: 0, explain: "Indolent (অলস) এর প্রতিশব্দ হলো Lazy (অলস)।" },
            { id: 27, q: "Choose the Bengali meaning of 'fortuitous'", options: ["পরিকল্পিত", "ইচ্ছাকৃত", "আকস্মিক", "দুর্ভাগ্যজনক"], answer: 2, explain: "Fortuitous (আকস্মিক, অপ্রত্যাশিত) অর্থ হলো অপ্রত্যাশিতভাবে বা ভাগ্যক্রমে কিছু ঘটা। সঠিক উত্তরটি হলো 'আকস্মিক'।" },
            { id: 28, q: "Choose the Antonym of 'querulous'", options: ["Complaining", "Content", "Peevish", "Irritable"], answer: 1, explain: "Querulous (অভিযোগপূর্ণ) এর বিপরীত শব্দ হলো Content (সন্তুষ্ট)।" },
            { id: 29, q: "Choose the Bengali meaning of 'circumspect'", options: ["অসতর্ক", "নির্বোধ", "সতর্ক", "উদাসীন"], answer: 2, explain: "Circumspect (সতর্ক) অর্থ হলো ঝুঁকি এড়াতে খুব সতর্ক থাকা। সঠিক উত্তরটি হলো 'সতর্ক'।" },
            { id: 30, q: "Choose the synonym of 'delineate'", options: ["Blur", "Describe", "Distort", "Hide"], answer: 1, explain: "Delineate (বর্ণনা করা, চিত্রিত করা) এর প্রতিশব্দ হলো Describe (বর্ণনা করা)।" },
            { id: 31, q: "Choose the Bengali meaning of 'exacerbate'", options: ["উন্নতি করা", "খারাপ করা", "সহজ করা", "নিরাময় করা"], answer: 1, explain: "Exacerbate (খারাপ করা) অর্থ হলো কোনো খারাপ পরিস্থিতি বা সমস্যাকে আরও খারাপ করা। সঠিক উত্তরটি হলো 'খারাপ করা'।" },
            { id: 32, q: "Choose the Antonym of 'transmute'", options: ["Change", "Transform", "Maintain", "Convert"], answer: 2, explain: "Transmute (রূপান্তরিত করা) এর বিপরীত শব্দ হলো Maintain (বজায় রাখা)।" },
            { id: 33, q: "Choose the Bengali meaning of 'nefarious'", options: ["সৎ", "পুণ্যবান", "দুষ্ট", "সদয়"], answer: 2, explain: "Nefarious (দুষ্ট) অর্থ হলো অত্যন্ত খারাপ বা অপরাধমূলক। সঠিক উত্তরটি হলো 'দুষ্ট'।" },
            { id: 34, q: "Choose the synonym of 'prodigal'", options: ["Wasteful", "Thrifty", "Economical", "Frugal"], answer: 0, explain: "Prodigal (অমিতব্যয়ী) এর প্রতিশব্দ হলো Wasteful (অমিতব্যয়ী)।" },
            { id: 35, q: "Choose the Bengali meaning of 'sycophant'", options: ["সমালোচক", "প্রশংসক", "চাটুকার", "নেতা"], answer: 2, explain: "Sycophant (চাটুকার) অর্থ হলো এমন ব্যক্তি যে ক্ষমতাশীল কাউকে অতিরিক্ত প্রশংসা করে সুবিধা পাওয়ার জন্য। সঠিক উত্তরটি হলো 'চাটুকার'।" },
            { id: 36, q: "Choose the Antonym of 'recalcitrant'", options: ["Disobedient", "Rebellious", "Compliant", "Stubborn"], answer: 2, explain: "Recalcitrant (অবাধ্য) এর বিপরীত শব্দ হলো Compliant (বাধ্য, অনুগত)।" },
            { id: 37, q: "Choose the Bengali meaning of 'bellicose'", options: ["শান্তিপূর্ণ", "যুদ্ধপ্রিয়", "ভিতু", "সদয়"], answer: 1, explain: "Bellicose (যুদ্ধপ্রিয়) অর্থ হলো ঝগড়া বা যুদ্ধে লিপ্ত হতে ইচ্ছুক। সঠিক উত্তরটি হলো 'যুদ্ধপ্রিয়'।" },
            { id: 38, q: "Choose the synonym of 'parsimonious'", options: ["Generous", "Frugal", "Extravagant", "Wasteful"], answer: 1, explain: "Parsimonious (কৃপণ) এর প্রতিশব্দ হলো Frugal (মিতব্যয়ী)।" },
            { id: 39, q: "Choose the Bengali meaning of 'sagacious'", options: ["নির্বোধ", "জ্ঞানী", "অজ্ঞ", "অসাবধানী"], answer: 1, explain: "Sagacious (জ্ঞানী) অর্থ হলো বিচক্ষণ ও জ্ঞানী। সঠিক উত্তরটি হলো 'জ্ঞানী'।" },
            { id: 40, q: "Choose the Antonym of 'gauche'", options: ["Clumsy", "Awkward", "Elegant", "Uncouth"], answer: 2, explain: "Gauche (অনাড়ম্বর, অমার্জিত) এর বিপরীত শব্দ হলো Elegant (মার্জিত, সুন্দর)।" },
            { id: 41, q: "Choose the Bengali meaning of 'enervate'", options: ["সবল করা", "দুর্বল করা", "উজ্জীবিত করা", "উৎসাহ দেওয়া"], answer: 1, explain: "Enervate (দুর্বল করা) অর্থ হলো কারও শক্তি বা জীবনীশক্তি কেড়ে নেওয়া। সঠিক উত্তরটি হলো 'দুর্বল করা'।" },
            { id: 42, q: "Choose the synonym of 'recondite'", options: ["Obvious", "Simple", "Profound", "Common"], answer: 2, explain: "Recondite (দুর্বোধ্য, গভীর) এর প্রতিশব্দ হলো Profound (গভীর)।" },
            { id: 43, q: "Choose the Bengali meaning of 'disparate'", options: ["একই রকম", "ভিন্ন", "সমান", "মিলে যাওয়া"], answer: 1, explain: "Disparate (ভিন্ন) অর্থ হলো দুটি ভিন্ন জিনিস যা একে অপরের থেকে মৌলিকভাবে ভিন্ন। সঠিক উত্তরটি হলো 'ভিন্ন'।" },
            { id: 44, q: "Choose the Antonym of 'fallacious'", options: ["False", "Deceptive", "Valid", "Misleading"], answer: 2, explain: "Fallacious (ভুল, ভ্রান্ত) এর বিপরীত শব্দ হলো Valid (যুক্তিযুক্ত, বৈধ)।" },
            { id: 45, q: "Choose the Bengali meaning of 'laconic'", options: ["কথা বলা", "বাচাল", "সংক্ষিপ্ত", "বর্ণনামূলক"], answer: 2, explain: "Laconic (সংক্ষিপ্ত) অর্থ হলো অল্প কথায় কিছু বলা বা লেখা। সঠিক উত্তরটি হলো 'সংক্ষিপ্ত'।" },
            { id: 46, q: "Choose the synonym of 'perfidious'", options: ["Loyal", "Faithful", "Deceitful", "Honest"], answer: 2, explain: "Perfidious (বিশ্বাসঘাতক) এর প্রতিশব্দ হলো Deceitful (প্রতারক)।" },
            { id: 47, q: "Choose the Bengali meaning of 'obsequious'", options: ["অহংকারী", "অবাধ্য", "চাটুকার", "ভদ্র"], answer: 2, explain: "Obsequious (চাটুকার) অর্থ হলো অতিরিক্ত চাটুকার বা বাধ্য। সঠিক উত্তরটি হলো 'চাটুকার'।" },
            { id: 48, q: "Choose the Antonym of 'penurious'", options: ["Miserly", "Generous", "Stingy", "Poor"], answer: 1, explain: "Penurious (কৃপণ, অভাবগ্রস্ত) এর বিপরীত শব্দ হলো Generous (বদান্য)।" },
            { id: 49, q: "Choose the Bengali meaning of 'quiescent'", options: ["সক্রিয়", "নিষ্ক্রিয়", "বিক্ষুব্ধ", "শান্ত"], answer: 3, explain: "Quiescent (শান্ত, নিষ্ক্রিয়) অর্থ হলো একটি শান্ত বা নিষ্ক্রিয় অবস্থায় থাকা। সঠিক উত্তরটি হলো 'শান্ত'।" },
            { id: 50, q: "Choose the synonym of 'sanctimonious'", options: ["Pious", "Sincere", "Hypocritical", "Devout"], answer: 2, explain: "Sanctimonious (ধর্মপরায়ণতার ভান করা) এর প্রতিশব্দ হলো Hypocritical (ভণ্ড)।" },
            { id: 51, q: "Choose the Bengali meaning of 'sanguine'", options: ["বিষণ্ণ", "সংশয়পূর্ণ", "আশাবাদী", "ভীত"], answer: 2, explain: "Sanguine (আশাবাদী) অর্থ হলো আশাবাদী ও আত্মবিশ্বাসী। সঠিক উত্তরটি হলো 'আশাবাদী'।" },
            { id: 52, q: "Choose the Antonym of 'inscrutable'", options: ["Mysterious", "Unfathomable", "Clear", "Obscure"], answer: 2, explain: "Inscrutable (দুর্বোধ্য) এর বিপরীত শব্দ হলো Clear (স্পষ্ট, বোধগম্য)।" },
            { id: 53, q: "Choose the Bengali meaning of 'transient'", options: ["স্থায়ী", "ক্ষণস্থায়ী", "অনন্ত", "দীর্ঘমেয়াদী"], answer: 1, explain: "Transient (ক্ষণস্থায়ী) অর্থ হলো খুব অল্প সময়ের জন্য থাকা। সঠিক উত্তরটি হলো 'ক্ষণস্থায়ী'।" },
            { id: 54, q: "Choose the synonym of 'venerate'", options: ["Disrespect", "Admire", "Mock", "Despise"], answer: 1, explain: "Venerate (শ্রদ্ধা করা) এর প্রতিশব্দ হলো Admire (প্রশংসা করা)।" },
            { id: 55, q: "Choose the Bengali meaning of 'zealous'", options: ["উদাসীন", "নিরুৎসাহী", "উৎসাহী", "শান্ত"], answer: 2, explain: "Zealous (উৎসাহী) অর্থ হলো কোনো কিছুতে দারুণ উৎসাহ বা আগ্রহ দেখানো। সঠিক উত্তরটি হলো 'উৎসাহী'।" },
            { id: 56, q: "Choose the Antonym of 'ubiquitous'", options: ["Common", "Widespread", "Rare", "Omnipresent"], answer: 2, explain: "Ubiquitous (সর্বত্র বিদ্যমান) এর বিপরীত শব্দ হলো Rare (বিরল)।" },
            { id: 57, q: "Choose the Bengali meaning of 'apathy'", options: ["আগ্রহ", "উদাসীনতা", "উৎসাহ", "অনুভূতি"], answer: 1, explain: "Apathy (উদাসীনতা) অর্থ হলো কোনো কিছুতে আগ্রহ বা উদ্বেগের অভাব। সঠিক উত্তরটি হলো 'উদাসীনতা'।" },
            { id: 58, q: "Choose the synonym of 'cajole'", options: ["Coax", "Bully", "Threaten", "Force"], answer: 0, explain: "Cajole (ফুসলানো, তোষামোদ করা) এর প্রতিশব্দ হলো Coax (ফুসলানো)।" },
            { id: 59, q: "Choose the Bengali meaning of 'deference'", options: ["অসম্মান", "বিরোধিতা", "সম্মান", "উপেক্ষা"], answer: 2, explain: "Deference (সম্মান, আনুগত্য) অর্থ হলো শ্রদ্ধা বা সম্মান দেখানো। সঠিক উত্তরটি হলো 'সম্মান'।" },
            { id: 60, q: "Choose the Antonym of 'effervescent'", options: ["Lively", "Dull", "Bubbly", "Vivacious"], answer: 1, explain: "Effervescent (সজীব, ফুরফুরে) এর বিপরীত শব্দ হলো Dull (নিস্তেজ)।" },
            { id: 61, q: "Choose the Bengali meaning of 'elucidate'", options: ["অস্পষ্ট করা", "বোঝা", "ব্যাখ্যা করা", "গোপন করা"], answer: 2, explain: "Elucidate (ব্যাখ্যা করা) অর্থ হলো কোনো কিছুকে স্পষ্ট বা সহজবোধ্য করা। সঠিক উত্তরটি হলো 'ব্যাখ্যা করা'।" },
            { id: 62, q: "Choose the synonym of 'garrulous'", options: ["Talkative", "Quiet", "Reticent", "Taciturn"], answer: 0, explain: "Garrulous (বাচাল) এর প্রতিশব্দ হলো Talkative (বাচাল)।" },
            { id: 63, q: "Choose the Bengali meaning of 'histrionic'", options: ["শান্ত", "বাস্তবসম্মত", "নাটকীয়", "অপ্রকাশিত"], answer: 2, explain: "Histrionic (নাটকীয়) অর্থ হলো অতিমাত্রায় নাটকীয় বা আবেগপূর্ণ আচরণ। সঠিক উত্তরটি হলো 'নাটকীয়'।" },
            { id: 64, q: "Choose the Antonym of 'immutable'", options: ["Fixed", "Unchangeable", "Mutable", "Constant"], answer: 2, explain: "Immutable (অপরিবর্তনীয়) এর বিপরীত শব্দ হলো Mutable (পরিবর্তনশীল)।" },
            { id: 65, q: "Choose the Bengali meaning of 'incipient'", options: ["শেষ", "শুরু", "সম্পূর্ণ", "বিকশিত"], answer: 1, explain: "Incipient (শুরু) অর্থ হলো কোনো কিছুর প্রাথমিক পর্যায় বা শুরু। সঠিক উত্তরটি হলো 'শুরু'।" },
            { id: 66, q: "Choose the synonym of 'juxtapose'", options: ["Separate", "Combine", "Place side by side", "Disconnect"], answer: 2, explain: "Juxtapose (পাশাপাশি রাখা) এর প্রতিশব্দ হলো Place side by side (পাশাপাশি রাখা)।" },
            { id: 67, q: "Choose the Bengali meaning of 'kowtow'", options: ["সম্মান করা", "বিরোধিতা করা", "উপেক্ষা করা", "অসম্মান করা"], answer: 0, explain: "Kowtow (সম্মান করা) অর্থ হলো গভীর সম্মান প্রদর্শন করা। সঠিক উত্তরটি হলো 'সম্মান করা'।" },
            { id: 68, q: "Choose the Antonym of 'languid'", options: ["Energetic", "Slow", "Tired", "Lazy"], answer: 0, explain: "Languid (নিস্তেজ, অলস) এর বিপরীত শব্দ হলো Energetic (শক্তিমান)।" },
            { id: 69, q: "Choose the Bengali meaning of 'mercurial'", options: ["স্থিতিশীল", "অস্থির", "ধীর", "শান্ত"], answer: 1, explain: "Mercurial (অস্থির) অর্থ হলো দ্রুত ও অপ্রত্যাশিতভাবে মেজাজ বা আচরণের পরিবর্তন। সঠিক উত্তরটি হলো 'অস্থির'।" },
            { id: 70, q: "Choose the synonym of 'neophyte'", options: ["Expert", "Novice", "Veteran", "Professional"], answer: 1, explain: "Neophyte (নতুন শিক্ষার্থী, অনভিজ্ঞ) এর প্রতিশব্দ হলো Novice (নবীন)।" },
            { id: 71, q: "Choose the Bengali meaning of 'obstreperous'", options: ["শান্ত", "আদেশ মান্যকারী", "গোলমালকারী", "ভদ্র"], answer: 2, explain: "Obstreperous (গোলমালকারী) অর্থ হলো হৈচৈপূর্ণ ও নিয়ন্ত্রণ করা কঠিন। সঠিক উত্তরটি হলো 'গোলমালকারী'।" },
            { id: 72, q: "Choose the Antonym of 'palliative'", options: ["Soothing", "Curing", "Relieving", "Eradicating"], answer: 3, explain: "Palliative (উপশমকারী) এর বিপরীত শব্দ হলো Eradicating (নির্মূলকারী)।" },
            { id: 73, q: "Choose the Bengali meaning of 'platitude'", options: ["মূল ধারণা", "সাধারণ কথা", "গভীর চিন্তা", "নতুন ধারণা"], answer: 1, explain: "Platitude (সাধারণ কথা) অর্থ হলো এমন একটি বিবৃতি যা অতি ব্যবহৃত বা সাধারণ হয়ে গেছে। সঠিক উত্তরটি হলো 'সাধারণ কথা'।" },
            { id: 74, q: "Choose the synonym of 'querulous'", options: ["Complain", "Content", "Cheerful", "Happy"], answer: 0, explain: "Querulous (অভিযোগপূর্ণ) এর প্রতিশব্দ হলো Complain (অভিযোগ করা)।" },
            { id: 75, q: "Choose the Bengali meaning of 'reprobate'", options: ["নীতিবান", "পুণ্যবান", "দুষ্ট", "সৎ"], answer: 2, explain: "Reprobate (দুষ্ট, নীতিহীন) অর্থ হলো নৈতিকভাবে অসৎ বা খারাপ ব্যক্তি। সঠিক উত্তরটি হলো 'দুষ্ট'।" },
            { id: 76, q: "Choose the Antonym of 'salubrious'", options: ["Healthy", "Beneficial", "Harmful", "Wholesome"], answer: 2, explain: "Salubrious (স্বাস্থ্যকর) এর বিপরীত শব্দ হলো Harmful (ক্ষতিকর)।" },
            { id: 77, q: "Choose the Bengali meaning of 'sardonic'", options: ["মৃদু", "রসিক", "বিদ্রূপাত্মক", "সদয়"], answer: 2, explain: "Sardonic (বিদ্রূপাত্মক) অর্থ হলো অবজ্ঞাপূর্ণ এবং তিক্ত রসবোধ। সঠিক উত্তরটি হলো 'বিদ্রূপাত্মক'।" },
        ];

        // ----------------------------
        // State
        // ----------------------------
        let currentUser = null;
        let rankingData = [];
        let selectedIds = [];
        let selectedMap = {}; // { qid: optionIndex }
        let endTime = null; // epoch seconds
        let submitted = false;
        let timerHandle = null;

        // ----------------------------
        // DOM Elements
        // ----------------------------
        const loginSection = qs('#login-section');
        const usernameInput = qs('#username-input');
        const saveUsernameBtn = qs('#save-username-btn');
        const userInfoDisplay = qs('#user-info-display');
        const introEl = qs('#intro');
        const examForm = qs('#exam');
        const startBtn = qs('#startBtn');
        const resetBtn = qs('#resetBtn');
        const submitBtn = qs('#submitBtn');
        const timerEl = qs('#timer');
        const summaryEl = qs('#summary');
        const actionsEl = qs('.actions');
        const buttonContainer = qs('.button-container');
        const rankingBtn = qs('#rankingBtn');
        const rankingSection = qs('#ranking-section');
        const rankingTableBody = qs('#ranking-table-body');
        const userRankDisplay = qs('#user-rank-display');

        // ----------------------------
        // Rendering
        // ----------------------------
        function renderQuestions() {
            examForm.innerHTML = '';
            const chosen = QUESTIONS.filter(q => selectedIds.includes(q.id));
            chosen.forEach((q, idx) => {
                const qWrap = document.createElement('section');
                qWrap.className = 'question';
                qWrap.setAttribute('data-qid', q.id);

                qWrap.innerHTML = `
                    <div class="q-head">
                        <div class="q-num">${idx + 1}</div>
                        <div class="q-text">${q.q}</div>
                    </div>
                    <div class="options" role="radiogroup" aria-label="Question ${idx + 1}">
                        ${q.options.map((opt, i) => {
                            const checked = selectedMap[q.id] === i ? 'checked' : '';
                            return `
                                <label class="option">
                                    <input type="radio" name="q_${q.id}" value="${i}" ${checked} aria-label="Option ${String.fromCharCode(65 + i)}">
                                    <div class="opt-text"><strong>(${String.fromCharCode(65 + i)})</strong> ${opt}</div>
                                </label>
                            `;
                        }).join('')}
                    </div>
                `;
                examForm.appendChild(qWrap);
            });

            qsa('input[type=radio]', examForm).forEach(inp => {
                inp.addEventListener('change', e => {
                    const name = e.target.name;
                    const qid = parseInt(name.split('_')[1], 10);
                    selectedMap[qid] = parseInt(e.target.value, 10);
                    persist();
                });
            });
        }

        function renderSummary(score, details) {
            const total = EXAM_SIZE;
            const correct = details.filter(d => d.correct).length;
            const wrong = details.filter(d => d.user !== null && !d.correct).length;
            const unanswered = total - correct - wrong;

            summaryEl.classList.remove('hidden');
            summaryEl.innerHTML = `
                <div style="display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap">
                    <div style="display:flex; gap:12px; align-items:center">
                        <span class="score-badge" title="Final Score">Score: ${score.toFixed(2)} / ${total.toFixed(2)}</span>
                        <span class="chip correct-chip">✅ ${correct} correct</span>
                        <span class="chip wrong-chip">❌ ${wrong} wrong</span>
                        <span class="chip unanswered-chip">⏳ ${unanswered} unanswered</span>
                    </div>
                    <button onclick="window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'})">Go to Bottom</button>
                </div>
            `;
        }

        function markReview(details) {
            details.forEach((d) => {
                const sec = qs(`.question[data-qid="${d.id}"]`);
                if (!sec) return;
                const labels = qsa('.option', sec);
                labels.forEach((lab, i) => {
                    lab.classList.remove('correct', 'wrong');
                    if (i === d.answer) lab.classList.add('correct');
                    if (d.user !== null && i === d.user && !d.correct) lab.classList.add('wrong');
                    lab.querySelector('input').disabled = true;
                });

                const expContainer = document.createElement('div');
                expContainer.className = 'explanation-container';

                const statusDiv = document.createElement('div');
                statusDiv.className = `result-status ${d.correct ? 'correct-status' : (d.user !== null ? 'wrong-status' : 'unanswered-status')}`;

                if (d.correct) {
                    statusDiv.innerHTML = `<i class="fas fa-check-circle"></i> Correct`;
                } else if (d.user !== null) {
                    statusDiv.innerHTML = `<i class="fas fa-times-circle"></i> Wrong`;
                } else {
                    statusDiv.innerHTML = `<i class="fas fa-question-circle"></i> Unanswered`;
                }

                const exp = document.createElement('p');
                exp.className = 'explain';
                exp.textContent = `ব্যাখ্যা: ${d.explain}`;

                expContainer.appendChild(statusDiv);
                expContainer.appendChild(exp);
                sec.appendChild(expContainer);
            });
        }
        
        function renderRanking() {
            const sortedRanking = rankingData.sort((a, b) => b.score - a.score);
            rankingTableBody.innerHTML = '';
            
            let userRank = -1;
            let userScore = 0;
            if(currentUser) {
                const userEntry = sortedRanking.find(u => u.username === currentUser.username);
                if(userEntry) {
                    userScore = userEntry.score;
                    userRank = sortedRanking.indexOf(userEntry) + 1;
                }
            }

            sortedRanking.forEach((user, index) => {
                const row = rankingTableBody.insertRow();
                if (currentUser && user.username === currentUser.username) {
                    row.classList.add('current-user');
                }
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${user.username}</td>
                    <td>${user.score.toFixed(2)}</td>
                `;
            });

            if(currentUser) {
                userRankDisplay.textContent = `Your Rank: #${userRank} (Score: ${userScore.toFixed(2)})`;
                userRankDisplay.classList.remove('hidden');
            }
        }
        
        function toggleRanking() {
            if (rankingSection.classList.contains('hidden')) {
                rankingSection.classList.remove('hidden');
                introEl.classList.add('hidden');
                examForm.classList.add('hidden');
                summaryEl.classList.add('hidden');
                actionsEl.classList.add('hidden');
                buttonContainer.classList.add('hidden');
                renderRanking();
            } else {
                rankingSection.classList.add('hidden');
                if (!currentUser) {
                    loginSection.classList.remove('hidden');
                } else if (!submitted) {
                    introEl.classList.remove('hidden');
                    examForm.classList.add('hidden');
                } else {
                    examForm.classList.remove('hidden');
                    summaryEl.classList.remove('hidden');
                    actionsEl.classList.remove('hidden');
                    buttonContainer.classList.remove('hidden');
                    markReview(getReviewDetails());
                }
            }
        }

        function getReviewDetails() {
            const chosen = QUESTIONS.filter(q => selectedIds.includes(q.id));
            return chosen.map(q => {
                const user = (q.id in selectedMap) ? selectedMap[q.id] : null;
                const correct = user === q.answer;
                return { id: q.id, user, answer: q.answer, correct, explain: q.explain };
            });
        }
        
        function updateUserInfoDisplay() {
            if (currentUser) {
                userInfoDisplay.innerHTML = `<i class="fas fa-user-circle"></i> ${currentUser.username}`;
                userInfoDisplay.classList.remove('hidden');
            } else {
                userInfoDisplay.classList.add('hidden');
            }
        }
        
        // ----------------------------
        // Exam Flow
        // ----------------------------
        function startExam() {
            if (!currentUser) {
                alert("Please enter your name first!");
                return;
            }

            if (selectedIds.length === 0) {
                selectedIds = pick(QUESTIONS, EXAM_SIZE).map(q => q.id);
            }
            endTime = Math.floor(Date.now() / 1000) + EXAM_MINUTES * 60;
            submitted = false;
            submitBtn.disabled = false;

            // Hide other sections
            loginSection.classList.add('hidden');
            introEl.classList.add('hidden');
            summaryEl.classList.add('hidden');
            rankingSection.classList.add('hidden');
            
            // Show exam sections
            examForm.classList.remove('hidden');
            actionsEl.classList.remove('hidden');
            buttonContainer.classList.remove('hidden');
            
            renderQuestions();
            persist();
            startTimer();
        }

        function submitExam(reason = 'manual') {
            if (submitted) return;
            submitted = true;
            stopTimer();
            submitBtn.disabled = true;

            const chosen = QUESTIONS.filter(q => selectedIds.includes(q.id));
            const details = chosen.map(q => {
                const user = (q.id in selectedMap) ? selectedMap[q.id] : null;
                const correct = user === q.answer;
                return { id: q.id, user, answer: q.answer, correct, explain: q.explain };
            });

            const correctCount = details.filter(d => d.correct).length;
            const wrongCount = details.filter(d => d.user !== null && !d.correct).length;
            const score = correctCount * 1 + wrongCount * (-0.25);

            renderSummary(score, details);
            markReview(details);

            if (currentUser) {
                updateUserScore(currentUser.username, score);
            }

            persist();
        }

        function resetExam() {
            if (!currentUser) {
                loginSection.classList.remove('hidden');
                introEl.classList.add('hidden');
                examForm.classList.add('hidden');
                actionsEl.classList.add('hidden');
                buttonContainer.classList.add('hidden');
                rankingSection.classList.add('hidden');
                return;
            }

            stopTimer();
            clearState();
            selectedIds = [];
            selectedMap = {};
            endTime = null;
            submitted = false;
            timerEl.textContent = formatTime(EXAM_MINUTES * 60);
            submitBtn.disabled = true;
            summaryEl.classList.add('hidden');
            examForm.classList.add('hidden');
            actionsEl.classList.add('hidden');
            buttonContainer.classList.add('hidden');
            rankingSection.classList.add('hidden');
            introEl.classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ----------------------------
        // Timer
        // ----------------------------
        function startTimer() {
            stopTimer();
            tick();
            timerHandle = setInterval(tick, 1000);
        }

        function stopTimer() {
            if (timerHandle) {
                clearInterval(timerHandle);
                timerHandle = null;
            }
        }

        function tick() {
            const now = Math.floor(Date.now() / 1000);
            const remain = Math.max(0, endTime - now);
            timerEl.textContent = formatTime(remain);

            if (remain <= 60) {
                timerEl.style.background = '#2b0b0b';
                timerEl.style.color = '#fecaca';
                timerEl.style.borderColor = 'rgba(248,113,113,0.4)';
            } else if (remain <= 5 * 60) {
                timerEl.style.background = '#2b1a0b';
                timerEl.style.color = '#fde68a';
                timerEl.style.borderColor = 'rgba(245,158,11,0.4)';
            } else {
                timerEl.style.background = '#0b1a2f';
                timerEl.style.color = '#bfdbfe';
                timerEl.style.borderColor = 'rgba(96,165,250,0.35)';
            }

            if (remain === 0) {
                submitExam('timeout');
            }
        }

        // ----------------------------
        // User & Ranking
        // ----------------------------
        function updateUserScore(username, score) {
            let userExists = false;
            for (let i = 0; i < rankingData.length; i++) {
                if (rankingData[i].username === username) {
                    rankingData[i].score += score;
                    userExists = true;
                    break;
                }
            }
            if (!userExists) {
                rankingData.push({ username: username, score: score });
            }
            saveRankingData(rankingData);
            renderRanking();
        }

        // ----------------------------
        // Persistence (sessionStorage & localStorage)
        // ----------------------------
        function persist() {
            const state = { selectedIds, selectedMap, endTime, submitted };
            saveState(state);
        }

        function restore() {
            const user = loadUserData();
            if (user) {
                currentUser = user;
                updateUserInfoDisplay();
                loginSection.classList.add('hidden');
                introEl.classList.remove('hidden');
            } else {
                loginSection.classList.remove('hidden');
            }
            
            const state = loadState();
            if (!state) return;
            selectedIds = state.selectedIds || [];
            selectedMap = state.selectedMap || {};
            endTime = state.endTime || null;
            submitted = !!state.submitted;

            if (selectedIds.length) {
                introEl.classList.add('hidden');
                examForm.classList.remove('hidden');
                actionsEl.classList.remove('hidden');
                buttonContainer.classList.remove('hidden');
                renderQuestions();
                if (submitted) {
                    const details = getReviewDetails();
                    const correctCount = details.filter(d => d.correct).length;
                    const wrongCount = details.filter(d => d.user !== null && !d.correct).length;
                    const score = correctCount * 1 + wrongCount * (-0.25);
                    submitBtn.disabled = true;
                    renderSummary(score, details);
                    markReview(details);
                } else if (endTime) {
                    submitBtn.disabled = false;
                    startTimer();
                }
            }
        }

        // ----------------------------
        // Wiring
        // ----------------------------
        saveUsernameBtn.addEventListener('click', () => {
            const username = usernameInput.value.trim();
            if (username) {
                currentUser = { username: username };
                saveUserData(currentUser);
                updateUserInfoDisplay();
                loginSection.classList.add('hidden');
                introEl.classList.remove('hidden');
                resetExam();
            } else {
                alert('Please enter a valid name.');
            }
        });
        
        startBtn.addEventListener('click', () => {
            if (loadState() && !submitted) {
                if (!confirm('Start a new exam? Your current progress will be lost.')) return;
            }
            startExam();
        });
        
        resetBtn.addEventListener('click', resetExam);
        
        submitBtn.addEventListener('click', (e) => {
            e.preventDefault();
            submitExam('manual');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        
        rankingBtn.addEventListener('click', toggleRanking);

        window.addEventListener('beforeunload', (e) => {
            const state = loadState();
            if (state && state.selectedIds && state.selectedIds.length && !state.submitted) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // Initialize
        (function init() {
            timerEl.textContent = formatTime(EXAM_MINUTES * 60);
            rankingData = loadRankingData();
            restore();
        })();
    </script>
</body>
</html>